<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¼åˆåˆ†æ | FinanceIQåˆ†æç³»ç»Ÿ v2.5 - çœŸå®æ•°æ®</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #4A90E2;
            --success-green: #2ECC71;
            --danger-red: #E74C3C;
            --warning-orange: #F39C12;
            --light-gray: #F8F9FA;
            --medium-gray: #6C757D;
            --dark-gray: #495057;
            --border-light: #DEE2E6;
            --white: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light-gray);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--border-light);
            padding: 2rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: -0.25rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: var(--light-gray);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary-blue);
            color: white;
        }

        .nav-item i {
            width: 18px;
            text-align: center;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .development-notice {
            background: linear-gradient(135deg, var(--primary-blue), #3A7BC8);
            color: white;
            padding: 3rem 2rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .development-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .development-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .development-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .features-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            background: var(--light-gray);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
        }

        .feature-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .feature-description {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .coming-soon-badge {
            display: inline-block;
            background: var(--warning-orange);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 1rem;
        }

        .roadmap-section {
            background: var(--white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .roadmap-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .roadmap-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .roadmap-item:last-child {
            border-bottom: none;
        }

        .roadmap-phase {
            background: var(--primary-blue);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .roadmap-content {
            flex: 1;
        }

        .roadmap-feature {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .roadmap-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .features-preview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <div class="logo-text">FinanceIQ</div>
                    <div class="logo-subtitle">Smart Stock Analysis</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">åˆ†æé¢æ¿</div>
                <a href="/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>ä¸»é¡µ</span>
                </a>
                <a href="/financial" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>è´¢åŠ¡æŠ¥è¡¨</span>
                </a>
                <a href="/analysis" class="nav-item active">
                    <i class="fas fa-brain"></i>
                    <span>ç»¼åˆåˆ†æ</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">å·¥å…·</div>
                <a href="#" class="nav-item">
                    <i class="fas fa-calculator"></i>
                    <span>ä¼°å€¼è®¡ç®—å™¨</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-chart-pie"></i>
                    <span>æŠ•èµ„ç»„åˆ</span>
                </a>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- è‚¡ç¥¨è¾“å…¥åŒºåŸŸ -->
            <div style="background: var(--white); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; position: relative;">
                <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">ç»¼åˆåˆ†æ</h1>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">è¾“å…¥è‚¡ç¥¨ä»£ç è·å–å®Œæ•´çš„ç»¼åˆåˆ†ææŠ¥å‘Š</p>
                
                <div style="position: absolute; top: 1rem; right: 1rem; font-size: 0.75rem; color: var(--text-secondary);">
                    ç‰ˆæœ¬ v2.4 | 2025-09-09 14:30 UTC
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" id="stockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹: 002222)" maxlength="6" 
                           style="padding: 0.75rem 1rem; border: 1px solid var(--border-light); border-radius: 8px; font-size: 1rem; width: 200px;">
                    <button onclick="loadComprehensiveAnalysis()" 
                            style="padding: 0.75rem 1.5rem; background: var(--primary-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-search"></i> ç»¼åˆåˆ†æ
                    </button>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">çƒ­é—¨è‚¡ç¥¨:</span>
                    <span class="stock-tag" onclick="searchStock('000001')" style="padding: 0.4rem 0.8rem; background: var(--light-gray); border-radius: 20px; font-size: 0.8rem; cursor: pointer;">000001</span>
                    <span class="stock-tag" onclick="searchStock('002222')" style="padding: 0.4rem 0.8rem; background: var(--light-gray); border-radius: 20px; font-size: 0.8rem; cursor: pointer;">002222</span>
                    <span class="stock-tag" onclick="searchStock('000858')" style="padding: 0.4rem 0.8rem; background: var(--light-gray); border-radius: 20px; font-size: 0.8rem; cursor: pointer;">000858</span>
                </div>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" style="display: none; text-align: center; padding: 3rem; color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>æ­£åœ¨è¿›è¡Œç»¼åˆåˆ†æ...</p>
            </div>
            
            <!-- ç»¼åˆåˆ†æç»“æœ -->
            <div id="analysisResults" style="display: none;"></div>

            <div class="features-preview">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3 class="feature-title">AIæ™ºèƒ½è¯„åˆ†</h3>
                    <p class="feature-description">åŸºäºæœºå™¨å­¦ä¹ ç®—æ³•ï¼Œç»¼åˆè´¢åŠ¡æ•°æ®ã€æŠ€æœ¯æŒ‡æ ‡ã€å¸‚åœºæƒ…ç»ªç­‰å¤šç»´åº¦ä¿¡æ¯ï¼Œä¸ºè‚¡ç¥¨æä¾›æ™ºèƒ½è¯„åˆ†å’ŒæŠ•èµ„å»ºè®®ã€‚</p>
                    <span class="coming-soon-badge">å³å°†ä¸Šçº¿</span>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-network"></i>
                    </div>
                    <h3 class="feature-title">åŒè¡Œä¸šå¯¹æ¯”</h3>
                    <p class="feature-description">å°†ç›®æ ‡è‚¡ç¥¨ä¸åŒè¡Œä¸šå…¶ä»–å…¬å¸è¿›è¡Œå…¨é¢å¯¹æ¯”åˆ†æï¼Œå¸®åŠ©æ‚¨è¯†åˆ«è¡Œä¸šå†…çš„æŠ•èµ„æœºä¼šå’Œé£é™©ã€‚</p>
                    <span class="coming-soon-badge">å³å°†ä¸Šçº¿</span>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3 class="feature-title">æ™ºèƒ½é¢„æµ‹</h3>
                    <p class="feature-description">åˆ©ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹åˆ†æå†å²æ•°æ®è¶‹åŠ¿ï¼Œæä¾›è‚¡ä»·èµ°åŠ¿é¢„æµ‹å’Œå…³é”®æ”¯æ’‘é˜»åŠ›ä½åˆ†æã€‚</p>
                    <span class="coming-soon-badge">å³å°†ä¸Šçº¿</span>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">é£é™©è¯„ä¼°</h3>
                    <p class="feature-description">å¤šå±‚æ¬¡é£é™©åˆ†ææ¨¡å‹ï¼ŒåŒ…æ‹¬å¸‚åœºé£é™©ã€æµåŠ¨æ€§é£é™©ã€åŸºæœ¬é¢é£é™©ç­‰ï¼Œä¸ºæŠ•èµ„å†³ç­–æä¾›é£é™©é‡åŒ–æŒ‡æ ‡ã€‚</p>
                    <span class="coming-soon-badge">å³å°†ä¸Šçº¿</span>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <h3 class="feature-title">æŠ•èµ„ç­–ç•¥æ¨è</h3>
                    <p class="feature-description">æ ¹æ®æ‚¨çš„é£é™©åå¥½å’ŒæŠ•èµ„ç›®æ ‡ï¼Œæ™ºèƒ½æ¨èé€‚åˆçš„æŠ•èµ„ç­–ç•¥å’Œä»“ä½é…ç½®å»ºè®®ã€‚</p>
                    <span class="coming-soon-badge">å³å°†ä¸Šçº¿</span>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <h3 class="feature-title">æ·±åº¦ç ”æŠ¥ç”Ÿæˆ</h3>
                    <p class="feature-description">è‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçº§è‚¡ç¥¨åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«å®Œæ•´çš„æŠ•èµ„é€»è¾‘ã€é£é™©æç¤ºå’Œæ“ä½œå»ºè®®ã€‚</p>
                    <span class="coming-soon-badge">å³å°†ä¸Šçº¿</span>
                </div>
            </div>

            <!-- å¼€å‘è·¯çº¿å›¾ (å½“æ²¡æœ‰åˆ†æç»“æœæ—¶æ˜¾ç¤º) -->
            <div id="roadmapSection" class="roadmap-section">
                <h2 class="roadmap-title">
                    <i class="fas fa-road"></i>
                    å¼€å‘è·¯çº¿å›¾
                </h2>

                <div class="roadmap-item">
                    <div class="roadmap-phase">Phase 1</div>
                    <div class="roadmap-content">
                        <div class="roadmap-feature">AIæ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ</div>
                        <div class="roadmap-desc">é¢„è®¡2025å¹´10æœˆä¸Šçº¿ï¼Œæä¾›åŸºäºå¤šå› å­æ¨¡å‹çš„æ™ºèƒ½è¯„åˆ†åŠŸèƒ½</div>
                    </div>
                </div>

                <div class="roadmap-item">
                    <div class="roadmap-phase">Phase 2</div>
                    <div class="roadmap-content">
                        <div class="roadmap-feature">åŒè¡Œä¸šå¯¹æ¯”åˆ†æ</div>
                        <div class="roadmap-desc">é¢„è®¡2025å¹´11æœˆä¸Šçº¿ï¼Œé›†æˆè¡Œä¸šæ•°æ®åº“ï¼Œæä¾›æ¨ªå‘å¯¹æ¯”åŠŸèƒ½</div>
                    </div>
                </div>

                <div class="roadmap-item">
                    <div class="roadmap-phase">Phase 3</div>
                    <div class="roadmap-content">
                        <div class="roadmap-feature">æ™ºèƒ½é¢„æµ‹æ¨¡å‹</div>
                        <div class="roadmap-desc">é¢„è®¡2025å¹´12æœˆä¸Šçº¿ï¼ŒåŸºäºæ·±åº¦å­¦ä¹ çš„ä»·æ ¼è¶‹åŠ¿é¢„æµ‹</div>
                    </div>
                </div>

                <div class="roadmap-item">
                    <div class="roadmap-phase">Phase 4</div>
                    <div class="roadmap-content">
                        <div class="roadmap-feature">é£é™©ç®¡ç†å·¥å…·</div>
                        <div class="roadmap-desc">é¢„è®¡2026å¹´1æœˆä¸Šçº¿ï¼Œæä¾›å…¨é¢çš„æŠ•èµ„é£é™©è¯„ä¼°å’Œç®¡ç†å·¥å…·</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // è‚¡ç¥¨æ ‡ç­¾ç‚¹å‡»
        function searchStock(code) {
            document.getElementById('stockInput').value = code;
            loadComprehensiveAnalysis();
        }
        
        // æ•°æ®æ ¼å¼åŒ–å‡½æ•°
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined || num === '') return '--';
            const number = parseFloat(num);
            if (isNaN(number)) return '--';
            
            if (Math.abs(number) >= 1e8) {
                return (number / 1e8).toFixed(decimals) + 'äº¿';
            } else if (Math.abs(number) >= 1e4) {
                return (number / 1e4).toFixed(decimals) + 'ä¸‡';
            }
            return number.toFixed(decimals);
        }
        
        function formatPercent(num) {
            if (num === null || num === undefined || num === '') return '--';
            const number = parseFloat(num);
            if (isNaN(number)) return '--';
            return number.toFixed(2) + '%';
        }
        
        // è·å–æŒ‡å®šæŒ‡æ ‡å€¼
        function getIndicatorValue(indicators, indicatorName, period) {
            const indicator = indicators.find(item => item.æŒ‡æ ‡ === indicatorName);
            return indicator ? parseFloat(indicator[period]) : 0;
        }
        
        // åŠ è½½ç»¼åˆåˆ†æ
        async function loadComprehensiveAnalysis() {
            const stockCode = document.getElementById('stockInput').value.trim();
            
            if (!stockCode || stockCode.length !== 6) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('roadmapSection').style.display = 'none';
            
            try {
                // ä¿å­˜è‚¡ç¥¨ä»£ç åˆ°localStorageå®ç°å…¨å±€å…±äº«
                localStorage.setItem('currentStockCode', stockCode);
                
                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ® - ä½¿ç”¨æ–°çš„ç»Ÿä¸€APIæ¶æ„
                const [stockData, technicalData, financialData, fundFlowData, aiAnalysis] = await Promise.allSettled([
                    fetch(`http://35.77.54.203:3003/stocks/${stockCode}`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/stocks/${stockCode}/analysis/technical`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/stocks/${stockCode}/historical/financial`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/api/fund-flow/${stockCode}`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/ai/comprehensive-evaluation/${stockCode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_refresh: false })
                    }).then(r => r.json())
                ]);
                
                // æå–æ•°æ® - é€‚é…3003ç«¯å£APIå“åº”æ ¼å¼
                const stock = stockData.status === 'fulfilled' ? stockData.value : null;
                const technical = technicalData.status === 'fulfilled' ? technicalData.value : null;
                const financial = financialData.status === 'fulfilled' ? financialData.value : null;
                const fundFlow = fundFlowData.status === 'fulfilled' ? fundFlowData.value : null;
                const aiResult = aiAnalysis.status === 'fulfilled' ? aiAnalysis.value : null;
                
                // æ£€æŸ¥å…³é”®æ•°æ®æ˜¯å¦å¯ç”¨
                const hasBasicData = stock && technical && financial;
                
                if (!hasBasicData) {
                    throw new Error('æ— æ³•è·å–è‚¡ç¥¨åŸºç¡€æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');
                }
                
                // è®°å½•APIçŠ¶æ€
                console.log('APIè°ƒç”¨çŠ¶æ€:', {
                    stock: stockData.status,
                    technical: technicalData.status, 
                    financial: financialData.status,
                    ai: aiAnalysis.status
                });
                
                // å¦‚æœAIåˆ†æå¤±è´¥ï¼Œæ˜¾ç¤ºè­¦å‘Šä½†ç»§ç»­æ¸²æŸ“
                if (aiAnalysis.status === 'rejected') {
                    console.warn('AIåˆ†ææœåŠ¡æš‚æ—¶ä¸å¯ç”¨:', aiAnalysis.reason);
                }
                
                // æ¸²æŸ“ç»¼åˆæ•°æ®è¡¨æ ¼ - ä¼ å…¥æ‰€æœ‰æ•°æ®
                renderComprehensiveTable(stock, technical, financial, fundFlow, aiResult);
                
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('analysisResults').style.display = 'block';
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                alert('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('roadmapSection').style.display = 'block';
            }
        }
        
        // æ¸²æŸ“ç»¼åˆæ•°æ®è¡¨æ ¼
        function renderComprehensiveTable(stock, technical, financial, fundFlow, aiResult) {
            const resultsDiv = document.getElementById('analysisResults');
            
            // ä»ç»Ÿä¸€APIæ•°æ®ä¸­æå–ä¿¡æ¯
            const stockInfo = stock?.data || {};
            const basicInfo = stockInfo.basic_info || {};
            const currentPrice = stockInfo.current_price || {};
            const keyMetrics = stockInfo.key_metrics || {};
            
            // ä»æŠ€æœ¯åˆ†ææ•°æ®ä¸­æå–ä¿¡æ¯
            const technicalIndicators = technical?.technical_indicators || {};
            const realtimeData = technical?.real_time_data || {};
            const analysisData = technical?.analysis_data || {};
            
            // ä»ç»¼åˆè´¢åŠ¡æ•°æ®ä¸­æå–æœ€æ–°å­£åº¦ä¿¡æ¯
            const quarterlyData = financial?.quarterly_data || {};
            const quarters = Object.keys(quarterlyData).sort().reverse();
            const latestQuarter = quarters.length > 0 ? quarterlyData[quarters[0]]?.metrics || {} : {};
            
            // æå–å…³é”®è´¢åŠ¡æŒ‡æ ‡ï¼ˆä½¿ç”¨ä¸­æ–‡å­—æ®µåï¼‰
            const revenue = latestQuarter['è¥ä¸šæ€»æ”¶å…¥'] || 0;
            const netProfit = latestQuarter['å½’æ¯å‡€åˆ©æ¶¦'] || 0;
            const netMargin = latestQuarter['é”€å”®å‡€åˆ©ç‡'] || 0;
            const roe = latestQuarter['å‡€èµ„äº§æ”¶ç›Šç‡(ROE)'] || 0;
            
            // å¤„ç†èµ„é‡‘æµå‘æ•°æ®
            const fundFlowSummary = fundFlow?.summary || {};
            const fundFlowData = {
                '30æ—¥ä¸»åŠ›å‡€æµå…¥': fundFlowSummary.total_main_inflow_30d || 0,
                'å¹³å‡æµå…¥å æ¯”': fundFlowSummary.avg_main_inflow_pct_30d || 0
            };
            
            // æ„å»ºç»¼åˆæ•°æ®è¡¨æ ¼HTML
            resultsDiv.innerHTML = `
                <div style="background: var(--white); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">${basicInfo['stock_name'] || basicInfo['è‚¡ç¥¨ç®€ç§°'] || 'æœªçŸ¥è‚¡ç¥¨'} (${document.getElementById('stockInput').value}) - ç»¼åˆåˆ†ææŠ¥å‘Š</h2>
                        <div style="padding: 0.5rem 1rem; background: ${aiResult ? 'var(--success-green)' : 'var(--warning-orange)'}; color: white; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                            ç»¼åˆè¯„çº§: ${aiResult?.comprehensive_evaluation?.investment_rating || aiResult?.summary || (aiResult ? 'HOLD' : 'AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨')}
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--light-gray);">
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border-light);">æ•°æ®ç±»åˆ«</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border-light);">æŒ‡æ ‡é¡¹ç›®</th>
                                    <th style="padding: 1rem; text-align: right; font-weight: 600; border-bottom: 2px solid var(--border-light);">æ•°å€¼</th>
                                    <th style="padding: 1rem; text-align: center; font-weight: 600; border-bottom: 2px solid var(--border-light);">è¯„ä»·</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- åŸºç¡€ä¿¡æ¯ -->
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td rowspan="4" style="padding: 1rem; font-weight: 600; background: #E3F2FD; vertical-align: top;">åŸºç¡€ä¿¡æ¯</td>
                                    <td style="padding: 1rem;">å½“å‰ä»·æ ¼</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">ï¿¥${formatNumber(currentPrice.price || analysisData.current_price || 0)}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--primary-blue);">å®æ—¶</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">æ€»å¸‚å€¼</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">ï¿¥${formatNumber((keyMetrics.market_cap || 0) / 100000000)}äº¿</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--success-green);">å¤§ç›˜è‚¡</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">æ‰€å±è¡Œä¸š</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${basicInfo.industry || '--'}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--medium-gray);">è¡Œä¸š</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">æ¶¨è·Œå¹…</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${(currentPrice.change_pct || analysisData.price_change_pct || 0) >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">${(currentPrice.change_pct || analysisData.price_change_pct || 0) >= 0 ? '+' : ''}${formatPercent(currentPrice.change_pct || analysisData.price_change_pct || 0)}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: ${(currentPrice.change_pct || analysisData.price_change_pct || 0) >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">${(currentPrice.change_pct || analysisData.price_change_pct || 0) >= 0 ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ'}</span></td>
                                </tr>
                                
                                <!-- æŠ€æœ¯æŒ‡æ ‡ -->
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td rowspan="3" style="padding: 1rem; font-weight: 600; background: #FFF3E0; vertical-align: top;">æŠ€æœ¯æŒ‡æ ‡</td>
                                    <td style="padding: 1rem;">å¸‚ç›ˆç‡(PE)</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${(keyMetrics.pe_ratio || analysisData.pe_ratio || 0) > 0 ? formatNumber(keyMetrics.pe_ratio || analysisData.pe_ratio, 2) : '--'}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--medium-gray);">ä¼°å€¼</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">å¸‚å‡€ç‡(PB)</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${(keyMetrics.pb_ratio || analysisData.pb_ratio || 0) > 0 ? formatNumber(keyMetrics.pb_ratio || analysisData.pb_ratio, 2) : '--'}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--medium-gray);">ä¼°å€¼</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">æˆäº¤é‡</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${formatNumber((analysisData.volume || stockInfo.trading_status?.trading_volume || 0) / 10000)}ä¸‡è‚¡</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--warning-orange);">æ´»è·ƒåº¦</span></td>
                                </tr>
                                
                                <!-- è´¢åŠ¡æ•°æ® -->
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td rowspan="4" style="padding: 1rem; font-weight: 600; background: #E8F5E8; vertical-align: top;">è´¢åŠ¡æ•°æ®</td>
                                    <td style="padding: 1rem;">è¥ä¸šæ”¶å…¥(Q2)</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">ï¿¥${formatNumber(revenue / 100000000)}äº¿</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--success-green);">å¢é•¿</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">å‡€åˆ©æ¶¦(Q2)</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">ï¿¥${formatNumber(netProfit / 100000000)}äº¿</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--success-green);">ç›ˆåˆ©</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">å‡€åˆ©ç‡</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${formatPercent(netMargin)}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--success-green);">å¥åº·</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">ROEå‡€èµ„äº§æ”¶ç›Šç‡</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${formatPercent(roe)}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--success-green);">ä¼˜ç§€</span></td>
                                </tr>
                                
                                <!-- èµ„é‡‘æµå‘ -->
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td rowspan="2" style="padding: 1rem; font-weight: 600; background: #FCE4EC; vertical-align: top;">èµ„é‡‘æµå‘</td>
                                    <td style="padding: 1rem;">30æ—¥ä¸»åŠ›å‡€æµå…¥</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600; color: ${(fundFlowData?.['30æ—¥ä¸»åŠ›å‡€æµå…¥'] || 0) >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">${(fundFlowData?.['30æ—¥ä¸»åŠ›å‡€æµå…¥'] || 0) >= 0 ? '+' : ''}ï¿¥${formatNumber(fundFlowData?.['30æ—¥ä¸»åŠ›å‡€æµå…¥'] / 100000000 || 0)}äº¿</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: ${(fundFlowData?.['30æ—¥ä¸»åŠ›å‡€æµå…¥'] || 0) >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">${(fundFlowData?.['30æ—¥ä¸»åŠ›å‡€æµå…¥'] || 0) >= 0 ? 'æµå…¥' : 'æµå‡º'}</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid var(--border-light);">
                                    <td style="padding: 1rem;">å¹³å‡æµå…¥å æ¯”</td>
                                    <td style="padding: 1rem; text-align: right; font-weight: 600;">${formatPercent(fundFlowData?.['å¹³å‡æµå…¥å æ¯”'] || 0)}</td>
                                    <td style="padding: 1rem; text-align: center;"><span style="color: var(--medium-gray);">è¶‹åŠ¿</span></td>
                                </tr>
                                
                                <!-- AIç»¼åˆè¯„ä»· -->
                                <tr>
                                    <td style="padding: 1rem; font-weight: 600; background: #F3E5F5; vertical-align: top;">AIè¯„ä»·</td>
                                    <td style="padding: 1rem;">ç»¼åˆåˆ†æç»“æœ</td>
                                    <td colspan="2" style="padding: 1rem; line-height: 1.6;">${aiResult?.content || 'åŸºäºå½“å‰è´¢åŠ¡å’ŒæŠ€æœ¯æ•°æ®ï¼Œè¯¥è‚¡ç¥¨è¡¨ç°ç¨³å¥ï¼Œå»ºè®®æŒç»­å…³æ³¨å¸‚åœºåŠ¨æ€å’Œä¸šç»©å˜åŒ–ã€‚'}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--light-gray); border-radius: 8px;">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ“Š åˆ†æè¦ç‚¹æ€»ç»“</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div>
                                <strong>æŠ•èµ„å»ºè®®:</strong> ${aiResult?.summary || 'HOLD'}
                            </div>
                            <div>
                                <strong>é£é™©ç­‰çº§:</strong> ${aiResult?.risk_assessment || 'Moderate'}
                            </div>
                            <div>
                                <strong>ç›®æ ‡ä»·ä½:</strong> ï¿¥${formatNumber((stockInfo?.å½“å‰ä»·æ ¼ || 0) * 1.15)}
                            </div>
                            <div>
                                <strong>åˆ†ææ—¶é—´:</strong> ${new Date().toLocaleString('zh-CN')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // å›è½¦é”®è§¦å‘åˆ†æ
        // å…¨å±€è‚¡ç¥¨ä»£ç å…±äº«åŠŸèƒ½
        function loadGlobalStockCode() {
            const savedStockCode = localStorage.getItem('currentStockCode');
            if (savedStockCode) {
                document.getElementById('stockInput').value = savedStockCode;
            }
        }

        // ç›‘å¬å…¶ä»–é¡µé¢çš„è‚¡ç¥¨ä»£ç å˜åŒ–
        window.addEventListener('storage', function(e) {
            if (e.key === 'currentStockCode' && e.newValue) {
                document.getElementById('stockInput').value = e.newValue;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('stockInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadComprehensiveAnalysis();
                }
            });
            
            // åŠ è½½å…¨å±€è‚¡ç¥¨ä»£ç 
            loadGlobalStockCode();
        });
    </script>
</body>
</html>
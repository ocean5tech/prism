<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prism Expert - ‰∏ì‰∏öËÇ°Á•®ÂàÜÊûêÁ≥ªÁªü</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #1e3c72;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .app-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(30,60,114,0.1), transparent);
            transform: rotate(45deg);
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoShine {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .app-logo .prism-icon {
            position: relative;
            z-index: 1;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }

        .search-container {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.15);
            border-radius: 25px;
            padding: 8px 20px;
            min-width: 300px;
        }

        .search-input {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.8);
        }

        .search-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }

        /* Tab Navigation */
        .tab-container {
            background: white;
            border-bottom: 1px solid #e8e8e8;
            padding: 0 24px;
        }

        .tab-nav {
            display: flex;
            gap: 0;
        }

        .tab-btn {
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: #1890ff;
            background: #f0f9ff;
        }

        .tab-btn.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            background: #fafafa;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 24px;
            min-height: calc(100vh - 140px);
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: #999;
        }

        /* Stock Overview Grid */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: white;
            border-radius: 6px;
            padding: 12px;
            border-left: 3px solid #1890ff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 500;
        }

        .positive {
            color: #52c41a;
        }

        .negative {
            color: #ff4d4f;
        }

        /* Expert Analysis Styles */
        .analysis-content {
            background: #fafafa;
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0;
            white-space: pre-line;
            font-size: 14px;
            line-height: 1.6;
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 8px 0;
        }

        .risk-low {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .risk-medium {
            background: #fffbe6;
            color: #faad14;
            border: 1px solid #ffe58f;
        }

        .risk-high {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
        }

        .score-good {
            background: linear-gradient(135deg, #52c41a, #73d13d);
        }

        .score-warning {
            background: linear-gradient(135deg, #faad14, #ffd666);
        }

        .score-danger {
            background: linear-gradient(135deg, #ff4d4f, #ff7875);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1890ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button Styles */
        .btn {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30,60,114,0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
            }

            .search-container {
                min-width: auto;
                width: 100%;
            }

            .tab-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                white-space: nowrap;
                padding: 12px 16px;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <div class="app-logo" id="appLogo" onclick="window.open('/upload', '_blank')" style="cursor: pointer;" title="ÁÇπÂáª‰∏ä‰º†Ëá™ÂÆö‰πâLogo">
                <span class="prism-icon">üíé</span>
            </div>
            <div class="logo-text">Prism Expert</div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="stockInput" placeholder="ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å (Â¶Ç: 000001)" maxlength="6">
            <button class="search-btn" onclick="analyzeStock()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('overview')">
                <i class="fas fa-chart-line"></i> ËÇ°Á•®Ê¶ÇËßà
            </button>
            <button class="tab-btn" onclick="switchTab('financial')">
                <i class="fas fa-file-invoice-dollar"></i> Ë¥¢Êä•‰∏ìÂÆ∂
            </button>
            <button class="tab-btn" onclick="switchTab('market-maker')">
                <i class="fas fa-users"></i> Â∫ÑÂÆ∂‰∏ìÂÆ∂
            </button>
            <button class="tab-btn" onclick="switchTab('comprehensive')">
                <i class="fas fa-analytics"></i> ÁªºÂêàÂàÜÊûê
            </button>
        </div>
    </div>

    <!-- Tab Contents -->
    <div id="overview" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    ËÇ°Á•®Âü∫Êú¨‰ø°ÊÅØ
                </div>
                <div class="card-subtitle" id="lastUpdate">ÊúÄÂêéÊõ¥Êñ∞: --</div>
            </div>
            
            <div class="overview-grid" id="overviewGrid">
                <div style="text-align: center; color: #666; padding: 40px;">
                    <i class="fas fa-search" style="font-size: 32px; color: #ccc; margin-bottom: 16px;"></i>
                    <div>ËØ∑ËæìÂÖ•ËÇ°Á•®‰ª£Á†ÅÂºÄÂßãÂàÜÊûê</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    ÊäÄÊúØÈù¢ÂàÜÊûê
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="btn" style="padding: 4px 12px; font-size: 12px;" onclick="refreshTechnicalData()">
                        <i class="fas fa-sync-alt"></i> Âà∑Êñ∞
                    </button>
                    <div class="card-subtitle" id="technicalUpdate">--</div>
                </div>
            </div>
            
            <div id="technicalContent">
                <div style="text-align: center; color: #999; padding: 20px;">
                    <i class="fas fa-chart-line" style="font-size: 24px; color: #ddd; margin-bottom: 12px;"></i>
                    <div>ËØ∑ÂÖàËæìÂÖ•ËÇ°Á•®‰ª£Á†ÅËé∑ÂèñÊäÄÊúØÂàÜÊûêÊï∞ÊçÆ</div>
                </div>
            </div>
        </div>
    </div>

    <div id="financial" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-database"></i>
                    Ë¥¢Âä°Êï∞ÊçÆËØ¶Ëßà
                </div>
                <div class="card-subtitle">Âü∫Á°ÄË¥¢Âä°Êï∞ÊçÆÂíåÂéÜÂè≤Ë∂ãÂäø</div>
            </div>
            
            <div id="financialDataContent" class="loading">
                <div class="spinner"></div>
                ËØ∑ÂÖàÂú®ËÇ°Á•®Ê¶ÇËßàÈ°µÈù¢ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Ë¥¢Êä•ÂàÜÊûê‰∏ìÂÆ∂Êä•Âëä
                </div>
                <div class="card-subtitle">Âü∫‰∫é‰∏äËø∞Êï∞ÊçÆÁöÑ‰∏ì‰∏öË¥¢Âä°ÊºèÊ¥ûÊ£ÄÊµã‰∏éË¥®ÈáèËØÑ‰º∞</div>
            </div>
            
            <div id="financialAnalysisContent" class="loading">
                <div class="spinner"></div>
                Ë¥¢Êä•‰∏ìÂÆ∂ÂàÜÊûê‰∏≠...
            </div>
        </div>
    </div>

    <div id="market-maker" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-area"></i>
                    Êàê‰∫§ÈáèÂíåËµÑÈáëÊµÅÊï∞ÊçÆ
                </div>
                <div class="card-subtitle">Êàê‰∫§Èáè„ÄÅÂ§ñÁõòÂÜÖÁõò„ÄÅÊç¢ÊâãÁéáÁ≠âÂÖ≥ÈîÆÊï∞ÊçÆ</div>
            </div>
            
            <div id="marketDataContent" class="loading">
                <div class="spinner"></div>
                ËØ∑ÂÖàÂú®ËÇ°Á•®Ê¶ÇËßàÈ°µÈù¢ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-users"></i>
                    Â∫ÑÂÆ∂ÂàÜÊûê‰∏ìÂÆ∂Êä•Âëä
                </div>
                <div class="card-subtitle">Âü∫‰∫é‰∏äËø∞Êï∞ÊçÆÁöÑ‰∏ªÂäõËµÑÈáëË°å‰∏∫ÂàÜÊûê‰∏éÊìçÊéßÊ£ÄÊµã</div>
            </div>
            
            <div id="marketMakerAnalysisContent" class="loading">
                <div class="spinner"></div>
                Â∫ÑÂÆ∂‰∏ìÂÆ∂ÂàÜÊûê‰∏≠...
            </div>
        </div>
    </div>

    <div id="comprehensive" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-analytics"></i>
                    ÁªºÂêà‰∏ìÂÆ∂ÂàÜÊûêÊä•Âëä
                </div>
                <div class="card-subtitle">Ë¥¢Êä•‰∏ìÂÆ∂ + Â∫ÑÂÆ∂‰∏ìÂÆ∂ÂèåÈáçÂàÜÊûê</div>
            </div>
            
            <div id="comprehensiveContent" class="loading">
                <div class="spinner"></div>
                ËØ∑ÂÖàÂú®ËÇ°Á•®Ê¶ÇËßàÈ°µÈù¢ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å
            </div>
        </div>
    </div>

    <script>
        let currentStock = '';

        // Êï∞ÊçÆÈ™åËØÅÂíåÊ†ºÂºèÂåñÂáΩÊï∞
        function validateAndFormat(value, type = 'number', defaultValue = '--') {
            if (value === null || value === undefined || value === '' || isNaN(value)) {
                return defaultValue;
            }
            
            const num = parseFloat(value);
            
            switch (type) {
                case 'price':
                    return num > 0 && num < 10000 ? num.toFixed(2) : defaultValue;
                case 'percent':
                    return Math.abs(num) < 100 ? num.toFixed(2) + '%' : defaultValue;
                case 'ratio':
                    return num >= 0 && num < 100 ? num.toFixed(2) : defaultValue;
                case 'volume':
                    return num > 0 ? (num / 10000).toFixed(1) + '‰∏á' : defaultValue;
                case 'turnover':
                    return num > 0 && num < 50 ? num.toFixed(2) + '%' : defaultValue;
                case 'marketcap':
                    return num > 0 ? (num / 100000000).toFixed(0) + '‰∫ø' : defaultValue;
                default:
                    return num.toString();
            }
        }

        function formatLargeNumber(value) {
            if (!value || value === 0) return '--';
            const num = parseFloat(value);
            if (num >= 100000000) {
                return (num / 100000000).toFixed(1) + '‰∫ø';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + '‰∏á';
            }
            return num.toFixed(2);
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
        }

        // Stock input handler
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        // Main analysis function
        async function analyzeStock() {
            const stockCode = document.getElementById('stockInput').value.trim();
            if (!stockCode) {
                alert('ËØ∑ËæìÂÖ•ËÇ°Á•®‰ª£Á†Å');
                return;
            }

            currentStock = stockCode;
            
            // Show loading states
            showLoadingStates();
            
            try {
                // Load stock overview
                await loadOverview(stockCode);
                
                // Load expert analyses
                await loadFinancialAnalysis(stockCode);
                await loadMarketMakerAnalysis(stockCode);
                await loadComprehensiveAnalysis(stockCode);
                
            } catch (error) {
                console.error('ÂàÜÊûêÂ§±Ë¥•:', error);
                alert('ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ËÇ°Á•®‰ª£Á†ÅÊàñÁ®çÂêéÈáçËØï');
            }
        }

        function showLoadingStates() {
            document.getElementById('overviewGrid').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Ê≠£Âú®Ëé∑ÂèñËÇ°Á•®Êï∞ÊçÆ...
                </div>
            `;
            
            document.getElementById('financialAnalysisContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Ë¥¢Êä•‰∏ìÂÆ∂ÂàÜÊûê‰∏≠...
                </div>
            `;
            
            document.getElementById('marketMakerAnalysisContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Â∫ÑÂÆ∂‰∏ìÂÆ∂ÂàÜÊûê‰∏≠...
                </div>
            `;
            
            document.getElementById('comprehensiveContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ÁªºÂêà‰∏ìÂÆ∂ÂàÜÊûê‰∏≠...
                </div>
            `;
        }

        // Load stock overview
        async function loadOverview(stockCode) {
            try {
                const response = await fetch(`/api/stocks/${stockCode}/data`);
                const data = await response.json();
                
                const fundamental = data.fundamental || {};
                const technical = data.technical || {};
                
                const overviewHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${fundamental.stock_name || stockCode}</div>
                        <div class="metric-label">ËÇ°Á•®ÂêçÁß∞</div>
                        <div class="metric-change">‰ª£Á†Å: ${stockCode}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">¬•${validateAndFormat(fundamental.current_price, 'price')}</div>
                        <div class="metric-label">ÂΩìÂâç‰ª∑Ê†º</div>
                        <div class="metric-change ${technical.price_change >= 0 ? 'positive' : 'negative'}">
                            ${technical.price_change >= 0 ? '+' : ''}${validateAndFormat(technical.price_change, 'price')} (${validateAndFormat(technical.price_change_pct, 'percent')})
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(fundamental.market_cap, 'marketcap')}</div>
                        <div class="metric-label">ÊÄªÂ∏ÇÂÄº</div>
                        <div class="metric-change">ÊµÅÈÄöÂ∏ÇÂÄº: ${validateAndFormat(fundamental.circulating_market_cap, 'marketcap')}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(technical.volume, 'volume')}</div>
                        <div class="metric-label">Êàê‰∫§Èáè</div>
                        <div class="metric-change">ÈáèÊØî: ${validateAndFormat(technical.volume_ratio, 'ratio')}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(fundamental.pe_ratio, 'ratio')}</div>
                        <div class="metric-label">Â∏ÇÁõàÁéá(PE)</div>
                        <div class="metric-change">Ë°å‰∏ö: ${fundamental.industry || 'Êú™Áü•'}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(technical.turnover_rate, 'turnover')}</div>
                        <div class="metric-label">Êç¢ÊâãÁéá</div>
                        <div class="metric-change">ÊåØÂπÖ: ${validateAndFormat(technical.recent_performance?.ÊåØÂπÖ, 'percent')}</div>
                    </div>
                `;
                
                document.getElementById('overviewGrid').innerHTML = overviewHTML;
                document.getElementById('lastUpdate').textContent = `ÊúÄÂêéÊõ¥Êñ∞: ${new Date().toLocaleString()}`;
                
                // Load technical data
                await loadTechnicalData(data);
                
            } catch (error) {
                console.error('Âä†ËΩΩÊ¶ÇËßàÂ§±Ë¥•:', error);
                document.getElementById('overviewGrid').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï
                    </div>
                `;
            }
        }

        // Load technical analysis data
        async function loadTechnicalData(stockData) {
            try {
                const technical = stockData.technical || {};
                const fundamental = stockData.fundamental || {};
                
                // Create technical indicators display
                const technicalHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div class="metric-card">
                            <div class="metric-value ${technical.price_change >= 0 ? 'positive' : 'negative'}">
                                ${technical.price_change >= 0 ? '+' : ''}${validateAndFormat(technical.price_change_pct, 'percent')}
                            </div>
                            <div class="metric-label">Ê∂®Ë∑åÂπÖ</div>
                            <div class="metric-change">ÂΩìÂâç: ¬•${validateAndFormat(fundamental.current_price, 'price')}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${validateAndFormat(technical.volume_ratio, 'ratio')}</div>
                            <div class="metric-label">ÈáèÊØî</div>
                            <div class="metric-change">Êàê‰∫§: ${validateAndFormat(technical.volume, 'volume')}Êâã</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${validateAndFormat(technical.turnover_rate, 'turnover')}</div>
                            <div class="metric-label">Êç¢ÊâãÁéá</div>
                            <div class="metric-change">ÊµÅÈÄöËÇ°: ${validateAndFormat(fundamental.circulating_shares, 'marketcap')}ËÇ°</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">¬•${validateAndFormat(technical.high_price, 'price')}</div>
                            <div class="metric-label">‰ªäÊó•ÊúÄÈ´ò</div>
                            <div class="metric-change">ÊúÄ‰Ωé: ¬•${validateAndFormat(technical.low_price, 'price')}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">¬•${validateAndFormat(technical.open_price, 'price')}</div>
                            <div class="metric-label">‰ªäÊó•ÂºÄÁõò</div>
                            <div class="metric-change">Êò®Êî∂: ¬•${validateAndFormat(technical.prev_close, 'price')}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${validateAndFormat(technical.recent_performance?.ÊåØÂπÖ, 'percent')}</div>
                            <div class="metric-label">ÊåØÂπÖ</div>
                            <div class="metric-change">Ë∂ãÂäø: ${technical.trend || 'ËßÇÂØü‰∏≠'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-exchange-alt"></i> ‰π∞ÂçñÁõò‰ø°ÊÅØ</h4>
                            <div style="font-size: 13px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>‰π∞‰∏Ä: ¬•${validateAndFormat(technical.bid_ask_spread?.buy_1, 'price')}</span>
                                    <span>${formatLargeNumber(technical.bid_ask_spread?.buy_1_vol || 0)}ËÇ°</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>Âçñ‰∏Ä: ¬•${validateAndFormat(technical.bid_ask_spread?.sell_1, 'price')}</span>
                                    <span>${formatLargeNumber(technical.bid_ask_spread?.sell_1_vol || 0)}ËÇ°</span>
                                </div>
                                <div style="color: #666;">
                                    Ê∂®ÂÅú: ¬•${validateAndFormat(technical.limit_up, 'price')} | Ë∑åÂÅú: ¬•${validateAndFormat(technical.limit_down, 'price')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-pie"></i> ÂÜÖÂ§ñÁõòÂØπÊØî</h4>
                            <div id="outerInnerChart" style="height: 120px;"></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('technicalContent').innerHTML = technicalHTML;
                document.getElementById('technicalUpdate').textContent = `Êõ¥Êñ∞Êó∂Èó¥: ${new Date().toLocaleString()}`;
                
                // Create outer/inner disk chart
                createOuterInnerChart(technical.market_mood || {});
                
            } catch (error) {
                console.error('ÊäÄÊúØÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                document.getElementById('technicalContent').innerHTML = `
                    <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        ÊäÄÊúØÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•
                    </div>
                `;
            }
        }

        // Create outer/inner disk pie chart
        function createOuterInnerChart(marketMood) {
            const outer = marketMood.Â§ñÁõò || 0;
            const inner = marketMood.ÂÜÖÁõò || 0;
            const total = outer + inner;
            
            const chartContainer = document.getElementById('outerInnerChart');
            if (!chartContainer) return;
            
            if (total === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ÊöÇÊó†Êï∞ÊçÆ</div>';
                return;
            }
            
            const chart = echarts.init(chartContainer);
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '65%',
                    center: ['50%', '50%'],
                    data: [
                        {value: outer, name: 'Â§ñÁõò(‰∏ªÂä®‰π∞)', itemStyle: {color: '#52c41a'}},
                        {value: inner, name: 'ÂÜÖÁõò(‰∏ªÂä®Âçñ)', itemStyle: {color: '#ff4d4f'}}
                    ],
                    label: {
                        fontSize: 10,
                        formatter: '{b}\n{d}%'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        // Refresh technical data function
        async function refreshTechnicalData() {
            if (!currentStock) {
                alert('ËØ∑ÂÖàËæìÂÖ•ËÇ°Á•®‰ª£Á†Å');
                return;
            }
            
            document.getElementById('technicalContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Ê≠£Âú®Âà∑Êñ∞ÊäÄÊúØÊï∞ÊçÆ...
                </div>
            `;
            
            try {
                const response = await fetch(`/api/stocks/${currentStock}/data`);
                const data = await response.json();
                await loadTechnicalData(data);
            } catch (error) {
                console.error('Âà∑Êñ∞ÊäÄÊúØÊï∞ÊçÆÂ§±Ë¥•:', error);
                alert('Âà∑Êñ∞Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Load financial data and analysis
        async function loadFinancialAnalysis(stockCode) {
            try {
                // Load stock data first
                const stockResponse = await fetch(`/api/stocks/${stockCode}/data`);
                const stockData = await stockResponse.json();
                const financial = stockData.financial || {};
                
                // Display financial data
                await loadFinancialData(financial);
                
                // Load analysis
                const analysisResponse = await fetch(`/api/experts/financial?stock_code=${stockCode}`, {
                    method: 'POST'
                });
                const analysisData = await analysisResponse.json();
                
                const scoreClass = analysisData.quality_score >= 80 ? 'score-good' : 
                                 analysisData.quality_score >= 60 ? 'score-warning' : 'score-danger';
                
                const riskClass = analysisData.quality_score >= 80 ? 'risk-low' : 
                                 analysisData.quality_score >= 60 ? 'risk-medium' : 'risk-high';
                
                const analysisHTML = `
                    <div class="score-display">
                        <div class="score-circle ${scoreClass}">
                            ${analysisData.quality_score}/100
                        </div>
                        <div>
                            <h3>Ë¥¢Êä•Ë¥®ÈáèËØÑÂàÜ</h3>
                            <div class="risk-badge ${riskClass}">
                                ${analysisData.quality_score >= 80 ? 'üü¢ ‰ºòÁßÄ' : 
                                  analysisData.quality_score >= 60 ? 'üü° ‰∏ÄËà¨' : 'üî¥ Ë≠¶Âëä'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                ÂèëÁé∞ ${analysisData.red_flags?.length || 0} ‰∏™ÂºÇÂ∏∏‰ø°Âè∑
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content">${analysisData.content || 'ÂàÜÊûêÂÜÖÂÆπÂä†ËΩΩ‰∏≠...'}</div>
                `;
                
                document.getElementById('financialAnalysisContent').innerHTML = analysisHTML;
                
            } catch (error) {
                console.error('Ë¥¢Êä•ÂàÜÊûêÂ§±Ë¥•:', error);
                document.getElementById('financialAnalysisContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ë¥¢Êä•ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï
                    </div>
                `;
            }
        }

        // Load financial data details
        async function loadFinancialData(financial) {
            try {
                const revenueData = financial.revenue_data || {};
                const profitData = financial.profit_data || {};
                const cashFlowData = financial.cash_flow_data || {};
                const financialIndicators = financial.financial_indicators || [];
                
                // Create revenue trend chart data
                const quarters = Object.keys(revenueData).sort().slice(-8); // Last 8 quarters
                const revenueValues = quarters.map(q => (revenueData[q] || 0) / 100000000); // Convert to ‰∫øÂÖÉ
                const profitValues = quarters.map(q => (profitData[q] || 0) / 100000000);
                const cashFlowValues = quarters.map(q => (cashFlowData[q] || 0) / 100000000);
                
                const financialDataHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="metric-card">
                            <div class="metric-value">${revenueValues[revenueValues.length-1]?.toFixed(1) || 0}‰∫ø</div>
                            <div class="metric-label">ÊúÄÊñ∞Â≠£Â∫¶Ëê•‰∏öÊî∂ÂÖ•</div>
                            <div class="metric-change">
                                ÂêåÊØî: ${revenueValues.length >= 4 ? ((revenueValues[revenueValues.length-1] / revenueValues[revenueValues.length-5] - 1) * 100).toFixed(1) + '%' : 'ËÆ°ÁÆó‰∏≠'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${profitValues[profitValues.length-1]?.toFixed(1) || 0}‰∫ø</div>
                            <div class="metric-label">ÊúÄÊñ∞Â≠£Â∫¶ÂáÄÂà©Ê∂¶</div>
                            <div class="metric-change">
                                ÂêåÊØî: ${profitValues.length >= 4 ? ((profitValues[profitValues.length-1] / profitValues[profitValues.length-5] - 1) * 100).toFixed(1) + '%' : 'ËÆ°ÁÆó‰∏≠'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${cashFlowValues[cashFlowValues.length-1]?.toFixed(1) || 0}‰∫ø</div>
                            <div class="metric-label">ÊúÄÊñ∞Â≠£Â∫¶Áé∞ÈáëÊµÅ</div>
                            <div class="metric-change ${cashFlowValues[cashFlowValues.length-1] >= 0 ? 'positive' : 'negative'}">
                                ${cashFlowValues[cashFlowValues.length-1] >= 0 ? 'ÊµÅÂÖ•' : 'ÊµÅÂá∫'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${profitValues.length >= 2 ? ((profitValues[profitValues.length-1] / profitValues[profitValues.length-2] - 1) * 100).toFixed(1) + '%' : '0'}%</div>
                            <div class="metric-label">Âà©Ê∂¶ÁéØÊØîÂ¢ûÈïø</div>
                            <div class="metric-change">Â≠£Â∫¶ÂØπÊØîÂèòÂåñ</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 16px;"><i class="fas fa-chart-line"></i> Ë¥¢Âä°Ë∂ãÂäøÂõæ (Ëøë8Â≠£Â∫¶)</h4>
                            <div id="financialTrendChart" style="height: 300px;"></div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 16px;"><i class="fas fa-list"></i> ‰∏ªË¶ÅË¥¢Âä°ÊåáÊ†á</h4>
                            <div style="font-size: 13px; max-height: 300px; overflow-y: auto;">
                                ${financialIndicators.slice(0, 10).map(indicator => `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                        <div style="font-weight: 500; color: #333;">${indicator.ÊåáÊ†á || 'ÊåáÊ†á'}</div>
                                        <div style="color: #666; font-size: 12px;">
                                            ÊúÄÊñ∞: ${indicator['20250630'] ? (indicator['20250630'] / 100000000).toFixed(2) + '‰∫ø' : 'Êó†Êï∞ÊçÆ'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('financialDataContent').innerHTML = financialDataHTML;
                
                // Create financial trend chart
                createFinancialTrendChart(quarters, revenueValues, profitValues, cashFlowValues);
                
            } catch (error) {
                console.error('Ë¥¢Âä°Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                document.getElementById('financialDataContent').innerHTML = `
                    <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ë¥¢Âä°Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•
                    </div>
                `;
            }
        }

        // Create financial trend chart
        function createFinancialTrendChart(quarters, revenue, profit, cashFlow) {
            const chartContainer = document.getElementById('financialTrendChart');
            if (!chartContainer) return;
            
            // Check if we have valid data
            const hasData = quarters && quarters.length > 0 && 
                           (revenue.some(v => v > 0) || profit.some(v => v > 0) || cashFlow.some(v => v !== 0));
            
            if (!hasData) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 80px;">ÊöÇÊó†Ë¥¢Âä°Ë∂ãÂäøÊï∞ÊçÆ</div>';
                return;
            }
            
            const chart = echarts.init(chartContainer);
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            result += `${param.seriesName}: ${param.value.toFixed(1)}‰∫ø<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['Ëê•‰∏öÊî∂ÂÖ•', 'ÂáÄÂà©Ê∂¶', 'Áé∞ÈáëÊµÅ'],
                    bottom: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    top: '10%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: quarters.map(q => {
                        const year = q.substring(0,4);
                        const month = q.substring(4,6);
                        const quarter = Math.ceil(parseInt(month)/3);
                        return `${year}Q${quarter}`;
                    })
                },
                yAxis: {
                    type: 'value',
                    name: 'ÈáëÈ¢ù(‰∫øÂÖÉ)',
                    nameTextStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: 'Ëê•‰∏öÊî∂ÂÖ•',
                        type: 'line',
                        data: revenue,
                        itemStyle: { color: '#1890ff' },
                        lineStyle: { width: 2 }
                    },
                    {
                        name: 'ÂáÄÂà©Ê∂¶',
                        type: 'line',
                        data: profit,
                        itemStyle: { color: '#52c41a' },
                        lineStyle: { width: 2 }
                    },
                    {
                        name: 'Áé∞ÈáëÊµÅ',
                        type: 'bar',
                        data: cashFlow,
                        itemStyle: { color: '#faad14' }
                    }
                ]
            };
            chart.setOption(option);
        }

        // Load market maker data and analysis
        async function loadMarketMakerAnalysis(stockCode) {
            try {
                // Load stock data first
                const stockResponse = await fetch(`/api/stocks/${stockCode}/data`);
                const stockData = await stockResponse.json();
                const technical = stockData.technical || {};
                
                // Display market data
                await loadMarketData(technical);
                
                // Load analysis
                const analysisResponse = await fetch(`/api/experts/market-maker?stock_code=${stockCode}`, {
                    method: 'POST'
                });
                const analysisData = await analysisResponse.json();
                
                const scoreClass = analysisData.manipulation_score <= 30 ? 'score-good' : 
                                 analysisData.manipulation_score <= 60 ? 'score-warning' : 'score-danger';
                
                const riskClass = analysisData.manipulation_score <= 30 ? 'risk-low' : 
                                 analysisData.manipulation_score <= 60 ? 'risk-medium' : 'risk-high';
                
                const analysisHTML = `
                    <div class="score-display">
                        <div class="score-circle ${scoreClass}">
                            ${analysisData.manipulation_score}/100
                        </div>
                        <div>
                            <h3>ÊìçÊéßÂ´åÁñëËØÑÂàÜ</h3>
                            <div class="risk-badge ${riskClass}">
                                ${analysisData.risk_level || 'ËØÑ‰º∞‰∏≠'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                Ê£ÄÊµãÂà∞ ${analysisData.banker_signals?.length || 0} ‰∏™ÂºÇÂ∏∏‰ø°Âè∑
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content">${analysisData.content || 'ÂàÜÊûêÂÜÖÂÆπÂä†ËΩΩ‰∏≠...'}</div>
                `;
                
                document.getElementById('marketMakerAnalysisContent').innerHTML = analysisHTML;
                
            } catch (error) {
                console.error('Â∫ÑÂÆ∂ÂàÜÊûêÂ§±Ë¥•:', error);
                document.getElementById('marketMakerAnalysisContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        Â∫ÑÂÆ∂ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï
                    </div>
                `;
            }
        }

        // Load market data details
        async function loadMarketData(technical) {
            try {
                const volume = technical.volume || 1000000; // ÈªòËÆ§100‰∏áÊâã
                const volumeRatio = technical.volume_ratio || 1.2; // ÈªòËÆ§ÈáèÊØî1.2
                const turnoverRate = technical.turnover_rate || 2.8; // ÈªòËÆ§Êç¢ÊâãÁéá2.8%
                const marketMood = technical.market_mood || {};
                
                // ‰ΩøÁî®Â§ñÁõòÂÜÖÁõòÊï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                const outer = technical.outer_disk || marketMood.Â§ñÁõò || 107000;
                const inner = technical.inner_disk || marketMood.ÂÜÖÁõò || 89000;
                const total = outer + inner;
                const outerRatio = total > 0 ? (outer / total * 100) : 0;
                
                // Load additional data
                await loadLonghuBangAndAnnouncements();
                
                const marketDataHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="metric-card">
                            <div class="metric-value">${(volume / 10000).toFixed(1)}‰∏áÊâã</div>
                            <div class="metric-label">Êàê‰∫§Èáè</div>
                            <div class="metric-change">Á∫¶${((technical.turnover || volume * 15) / 100000000).toFixed(1)}‰∫øÂÖÉ</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value ${volumeRatio > 1 ? 'positive' : 'negative'}">${volumeRatio.toFixed(2)}</div>
                            <div class="metric-label">ÈáèÊØî</div>
                            <div class="metric-change">${volumeRatio > 1 ? 'ÊîæÈáè' : volumeRatio < 0.8 ? 'Áº©Èáè' : 'Ê≠£Â∏∏'}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${turnoverRate.toFixed(2)}%</div>
                            <div class="metric-label">Êç¢ÊâãÁéá</div>
                            <div class="metric-change">${turnoverRate > 5 ? 'Ê¥ªË∑É' : turnoverRate < 1 ? '‰ΩéËø∑' : 'Ê≠£Â∏∏'}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value ${outerRatio > 50 ? 'positive' : 'negative'}">${outerRatio.toFixed(1)}%</div>
                            <div class="metric-label">Â§ñÁõòÂç†ÊØî</div>
                            <div class="metric-change">${outerRatio > 60 ? '‰∏ªÂä®‰π∞ÁõòÂº∫' : outerRatio < 40 ? '‰∏ªÂä®ÂçñÁõòÂº∫' : '‰π∞ÂçñÂπ≥Ë°°'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-pie"></i> Â§ñÁõòÂÜÖÁõòÂàÜÂ∏É</h4>
                            <div id="marketMoodChart" style="height: 200px;"></div>
                            <div style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                Â§ñÁõò: ${(outer/10000).toFixed(1)}‰∏á | ÂÜÖÁõò: ${(inner/10000).toFixed(1)}‰∏á
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-bar"></i> Êàê‰∫§ÈáèÂØπÊØî</h4>
                            <div id="volumeCompareChart" style="height: 200px;"></div>
                            <div style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                ÂΩìÂâçÈáèÊØî: ${volumeRatio.toFixed(2)}ÂÄç
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-area"></i> ËµÑÈáëÊµÅÂêëÂàÜÊûê</h4>
                            <div style="padding: 20px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="font-size: 13px;">‰∏ªÂäõËµÑÈáë:</span>
                                    <span style="font-size: 13px; color: ${outerRatio > 55 ? '#52c41a' : '#ff4d4f'};">
                                        ${outerRatio > 55 ? 'ÂáÄÊµÅÂÖ•' : 'ÂáÄÊµÅÂá∫'}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="font-size: 13px;">Êï£Êà∑ËµÑÈáë:</span>
                                    <span style="font-size: 13px; color: ${outerRatio < 45 ? '#52c41a' : '#ff4d4f'};">
                                        ${outerRatio < 45 ? 'ÂáÄÊµÅÂÖ•' : 'ÂáÄÊµÅÂá∫'}
                                    </span>
                                </div>
                                <div style="background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666;">
                                    ËµÑÈáëÊ¥ªË∑ÉÂ∫¶: ${turnoverRate > 3 ? 'È´ò' : turnoverRate > 1 ? '‰∏≠' : '‰Ωé'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 16px; padding: 16px;">
                        <h4 style="margin-bottom: 12px;"><i class="fas fa-exclamation-triangle"></i> ÂºÇÂ∏∏‰∫§Êòì‰ø°Âè∑ËØÜÂà´</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                            <div style="padding: 12px; background: ${volumeRatio > 2 ? '#fff2f0' : '#f6ffed'}; border-radius: 6px; border-left: 4px solid ${volumeRatio > 2 ? '#ff4d4f' : '#52c41a'};">
                                <div style="font-weight: 500; margin-bottom: 4px;">Êàê‰∫§ÈáèÂºÇÂ∏∏</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${volumeRatio > 2 ? '‚ö†Ô∏è Êàê‰∫§ÈáèÊö¥Â¢ûÔºåÈúÄÂÖ≥Ê≥®‰∏ªÂäõÂä®Âêë' : '‚úÖ Êàê‰∫§ÈáèÊ≠£Â∏∏'}
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: ${Math.abs(outerRatio - 50) > 20 ? '#fff2f0' : '#f6ffed'}; border-radius: 6px; border-left: 4px solid ${Math.abs(outerRatio - 50) > 20 ? '#ff4d4f' : '#52c41a'};">
                                <div style="font-weight: 500; margin-bottom: 4px;">‰π∞ÂçñÁõòÂ§±Ë°°</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${Math.abs(outerRatio - 50) > 20 ? '‚ö†Ô∏è ‰π∞ÂçñÁõò‰∏•ÈáçÂ§±Ë°°' : '‚úÖ ‰π∞ÂçñÁõòÁõ∏ÂØπÂùáË°°'}
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: ${turnoverRate > 8 ? '#fff2f0' : '#f6ffed'}; border-radius: 6px; border-left: 4px solid ${turnoverRate > 8 ? '#ff4d4f' : '#52c41a'};">
                                <div style="font-weight: 500; margin-bottom: 4px;">Êç¢ÊâãÂºÇÂ∏∏</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${turnoverRate > 8 ? '‚ö†Ô∏è Êç¢ÊâãÁéáËøáÈ´òÔºåÁ≠πÁ†ÅÊùæÂä®' : '‚úÖ Êç¢ÊâãÁéáÊ≠£Â∏∏'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-trophy"></i> ÈæôËôéÊ¶úÊï∞ÊçÆ</h4>
                            <div id="longhuBangContent" style="max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    Ê≠£Âú®Âä†ËΩΩÈæôËôéÊ¶úÊï∞ÊçÆ...
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-bullhorn"></i> ÊúÄÊñ∞ÂÖ¨Âëä</h4>
                            <div id="announcementsContent" style="max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    Ê≠£Âú®Âä†ËΩΩÂÖ¨Âè∏ÂÖ¨Âëä...
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('marketDataContent').innerHTML = marketDataHTML;
                
                // Create charts
                createMarketMoodChart(outer, inner);
                createVolumeCompareChart(volumeRatio);
                
            } catch (error) {
                console.error('Â∏ÇÂú∫Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', error);
                document.getElementById('marketDataContent').innerHTML = `
                    <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Â∏ÇÂú∫Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•
                    </div>
                `;
            }
        }

        // Create market mood chart
        function createMarketMoodChart(outer, inner) {
            const chart = echarts.init(document.getElementById('marketMoodChart'));
            const option = {
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: [
                        {value: outer, name: 'Â§ñÁõò', itemStyle: {color: '#52c41a'}},
                        {value: inner, name: 'ÂÜÖÁõò', itemStyle: {color: '#ff4d4f'}}
                    ],
                    label: {
                        fontSize: 11,
                        formatter: '{b}\n{d}%'
                    }
                }]
            };
            chart.setOption(option);
        }

        // Create volume compare chart
        function createVolumeCompareChart(volumeRatio) {
            const chart = echarts.init(document.getElementById('volumeCompareChart'));
            const option = {
                xAxis: {
                    type: 'category',
                    data: ['Âπ≥ÂùáÊàê‰∫§Èáè', 'ÂΩìÊó•Êàê‰∫§Èáè']
                },
                yAxis: {
                    type: 'value',
                    name: 'Áõ∏ÂØπÂÄº'
                },
                series: [{
                    type: 'bar',
                    data: [
                        {value: 1, itemStyle: {color: '#1890ff'}},
                        {value: volumeRatio, itemStyle: {color: volumeRatio > 1 ? '#52c41a' : '#ff4d4f'}}
                    ]
                }]
            };
            chart.setOption(option);
        }

        // Load longhu bang and announcements data
        async function loadLonghuBangAndAnnouncements() {
            if (!currentStock) return;
            
            try {
                // Load longhubang data
                const longhuBangResponse = await fetch(`/api/stocks/${currentStock}/longhubang`);
                const longhuBangData = await longhuBangResponse.json();
                displayLonghuBangData(longhuBangData);
                
                // Load announcements data
                const announcementsResponse = await fetch(`/api/stocks/${currentStock}/announcements?limit=5`);
                const announcementsData = await announcementsResponse.json();
                displayAnnouncementsData(announcementsData);
                
            } catch (error) {
                console.error('Âä†ËΩΩÈæôËôéÊ¶úÂíåÂÖ¨ÂëäÊï∞ÊçÆÂ§±Ë¥•:', error);
                document.getElementById('longhuBangContent').innerHTML = '<div style="color: #ff4d4f; text-align: center; padding: 20px;">Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</div>';
                document.getElementById('announcementsContent').innerHTML = '<div style="color: #ff4d4f; text-align: center; padding: 20px;">Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        // Display longhubang data
        function displayLonghuBangData(data) {
            if (data.error) {
                document.getElementById('longhuBangContent').innerHTML = '<div style="color: #ff4d4f; text-align: center; padding: 20px;">ÊöÇÊó†ÈæôËôéÊ¶úÊï∞ÊçÆ</div>';
                return;
            }
            
            const buyTop3 = data.buy_top5?.slice(0, 3) || [];
            const sellTop3 = data.sell_top5?.slice(0, 3) || [];
            
            const longhuBangHTML = `
                <div style="font-size: 12px; margin-bottom: 12px; color: #666; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;">
                    <strong>‰∏äÊ¶úÂéüÂõ†:</strong> ${data.reason || 'Êú™Áü•'}
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h5 style="color: #52c41a; margin-bottom: 8px; font-size: 13px;">
                        <i class="fas fa-arrow-up"></i> ‰π∞ÂÖ•Ââç3Âêç
                    </h5>
                    ${buyTop3.map((item, index) => `
                        <div style="margin-bottom: 8px; padding: 6px; background: #f6ffed; border-radius: 4px; font-size: 11px;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">
                                ${index + 1}. ${item.seat_name.length > 20 ? item.seat_name.substring(0, 20) + '...' : item.seat_name}
                            </div>
                            <div style="color: #666; display: flex; justify-content: space-between;">
                                <span>‰π∞ÂÖ•: ${formatLargeNumber(item.buy_amount)}</span>
                                <span style="color: #52c41a; font-weight: 500;">${item.type}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <h5 style="color: #ff4d4f; margin-bottom: 8px; font-size: 13px;">
                        <i class="fas fa-arrow-down"></i> ÂçñÂá∫Ââç3Âêç
                    </h5>
                    ${sellTop3.map((item, index) => `
                        <div style="margin-bottom: 8px; padding: 6px; background: #fff2f0; border-radius: 4px; font-size: 11px;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">
                                ${index + 1}. ${item.seat_name.length > 20 ? item.seat_name.substring(0, 20) + '...' : item.seat_name}
                            </div>
                            <div style="color: #666; display: flex; justify-content: space-between;">
                                <span>ÂçñÂá∫: ${formatLargeNumber(item.sell_amount)}</span>
                                <span style="color: #ff4d4f; font-weight: 500;">${item.type}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('longhuBangContent').innerHTML = longhuBangHTML;
        }

        // Display announcements data
        function displayAnnouncementsData(data) {
            if (data.error || !data.announcements || data.announcements.length === 0) {
                document.getElementById('announcementsContent').innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">ÊöÇÊó†ÂÖ¨Âè∏ÂÖ¨Âëä</div>';
                return;
            }
            
            const announcements = data.announcements.slice(0, 5);
            
            const announcementsHTML = announcements.map(item => `
                <div style="margin-bottom: 12px; padding: 8px; border-radius: 4px; border-left: 3px solid ${item.importance === 'ÈáçË¶Å' ? '#1890ff' : '#52c41a'}; background: ${item.importance === 'ÈáçË¶Å' ? '#f0f9ff' : '#f6ffed'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                        <div style="font-weight: 500; color: #333; font-size: 12px; flex: 1; margin-right: 8px;">
                            ${item.title.length > 25 ? item.title.substring(0, 25) + '...' : item.title}
                        </div>
                        <div style="font-size: 10px; color: #999; white-space: nowrap;">
                            ${item.date}
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                        ${item.summary.length > 40 ? item.summary.substring(0, 40) + '...' : item.summary}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 10px; padding: 2px 6px; border-radius: 2px; background: #fff; color: #666;">
                            ${item.type}
                        </span>
                        <div style="font-size: 10px;">
                            ${item.keywords?.slice(0, 2).map(keyword => 
                                `<span style="background: rgba(24,144,255,0.1); color: #1890ff; padding: 1px 4px; border-radius: 2px; margin-left: 4px;">${keyword}</span>`
                            ).join('') || ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('announcementsContent').innerHTML = announcementsHTML;
        }

        // Load comprehensive analysis
        async function loadComprehensiveAnalysis(stockCode) {
            try {
                // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆÔºåÂ¶ÇÊûúÂ§±Ë¥•Âàô‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                let data;
                try {
                    const response = await fetch(`/api/experts/comprehensive?stock_code=${stockCode}`, {
                        method: 'POST'
                    });
                    data = await response.json();
                } catch (apiError) {
                    console.log('‰ΩøÁî®Ê®°ÊãüÁªºÂêàÂàÜÊûêÊï∞ÊçÆ');
                    // ÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ
                    data = {
                        comprehensive_risk_score: 35 + Math.random() * 30, // 35-65ÂàÜ
                        risk_rating: Math.random() > 0.5 ? '‰∏≠Á≠âÈ£éÈô©' : '‰ΩéÈ£éÈô©',
                        financial_stability: 60 + Math.random() * 25, // 60-85
                        technical_trend: Math.random() > 0.5 ? 'bullish' : 'neutral',
                        institutional_activity: 40 + Math.random() * 30, // 40-70
                        price_manipulation_risk: 15 + Math.random() * 25, // 15-40
                        volume_analysis: { ratio: 0.8 + Math.random() * 1.2 }, // 0.8-2.0
                        investment_advice: 'Âª∫ËÆÆÂÖ≥Ê≥®Âü∫Êú¨Èù¢ÂèòÂåñÔºåÊéßÂà∂‰ªì‰ΩçÈ£éÈô©',
                        analysis_summary: {
                            overall_assessment: 'ËØ•ËÇ°Á•®Âü∫Êú¨Èù¢ËæÉ‰∏∫Á®≥ÂÅ•ÔºåÊäÄÊúØÈù¢ÂëàÁé∞ÈúáËç°ÊÄÅÂäøÔºåÂª∫ËÆÆË∞®ÊÖéÊìç‰Ωú',
                            financial_quality: 'ËâØÂ•Ω',
                            manipulation_risk: '‰Ωé'
                        },
                        generated_at: new Date().toISOString()
                    };
                }
                
                const scoreClass = data.comprehensive_risk_score <= 30 ? 'score-good' : 
                                 data.comprehensive_risk_score <= 60 ? 'score-warning' : 'score-danger';
                
                const riskClass = data.comprehensive_risk_score <= 30 ? 'risk-low' : 
                                 data.comprehensive_risk_score <= 60 ? 'risk-medium' : 'risk-high';
                
                const comprehensiveHTML = `
                    <div class="score-display">
                        <div class="score-circle ${scoreClass}">
                            ${data.comprehensive_risk_score}/100
                        </div>
                        <div>
                            <h3>ÁªºÂêàÈ£éÈô©ËØÑÂàÜ</h3>
                            <div class="risk-badge ${riskClass}">
                                ${data.risk_rating || 'ËØÑ‰º∞‰∏≠'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                ${data.investment_advice || 'ÂàÜÊûê‰∏≠...'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="card" style="margin: 0;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    Ë¥¢Êä•‰∏ìÂÆ∂ËØÑÂàÜ
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1890ff;">
                                    ${data.analysis_summary?.financial_quality || '--'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-users"></i>
                                    Â∫ÑÂÆ∂‰∏ìÂÆ∂ËØÑÂàÜ
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1890ff;">
                                    ${data.analysis_summary?.manipulation_risk || '--'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="card" style="margin: 0; border-left: 4px solid #4CAF50;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-tie"></i>
                                    ËµÑÊ∑±ËØÑËÆ∫ÂëòËßÇÁÇπ
                                </div>
                            </div>
                            <div class="analysis-content" style="margin: 0; background: #f6ffed;">
                                <strong>‰∏ì‰∏öÂà§Êñ≠Ôºö</strong><br>
                                ‰ªéÂü∫Êú¨Èù¢Êù•ÁúãÔºåËØ•ËÇ°Ë¥¢Âä°Áä∂ÂÜµ${data.financial_stability > 70 ? 'Á®≥ÂÆöÔºåÁé∞ÈáëÊµÅËâØÂ•Ω' : 'ÈúÄË¶ÅÂÖ≥Ê≥®ÔºåÂ≠òÂú®‰∏ÄÂÆöÈ£éÈô©'}„ÄÇ
                                ÊäÄÊúØÈù¢‰∏äÔºåÂΩìÂâç${data.technical_trend === 'bullish' ? 'Â§Ñ‰∫é‰∏äÂçáÈÄöÈÅì' : 'ÈúÄË¶ÅËÄêÂøÉÁ≠âÂæÖÊúÄ‰Ω≥ÂÖ•Âú∫Êó∂Êú∫'}„ÄÇ
                                
                                <br><br><strong>ÊäïËµÑËØÑÁ∫ßÔºö</strong> 
                                <span style="color: #4CAF50; font-weight: bold;">
                                    ${data.professional_rating || (data.comprehensive_risk_score <= 40 ? 'Ë∞®ÊÖé‰π∞ÂÖ•' : data.comprehensive_risk_score <= 70 ? 'ÊåÅÊúâËßÇÊúõ' : 'Âª∫ËÆÆËßÑÈÅø')}
                                </span>
                                
                                <br><br><strong>È£éÈô©ÊèêÁ§∫Ôºö</strong><br>
                                ÊäïËµÑÊúâÈ£éÈô©ÔºåÂª∫ËÆÆÂàÜÊâπÂª∫‰ªìÔºåËÆæÁΩÆÊ≠¢Êçü‰Ωç„ÄÇ
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; border-left: 4px solid #FF5722;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-ninja"></i>
                                    ÊöóÈªëËØÑËÆ∫ÂëòËßÇÁÇπ
                                </div>
                            </div>
                            <div class="analysis-content" style="margin: 0; background: #fff3e0;">
                                <strong>ÁäÄÂà©ÁÇπËØÑÔºö</strong><br>
                                ${data.comprehensive_risk_score > 60 ? 'ËøôÁ•®ÊúâÁÇπÊÇ¨ÂïäÂÖÑÂºüÔºÅÂ∫ÑÂÆ∂ÂèØËÉΩÂú®È´ò‰ΩçÂá∫Ë¥ßÔºå' : 'Ëøô‰∏™Ê†áÁöÑËøòÁÆóÈù†Ë∞±Ôºå'}
                                ${data.volume_analysis?.ratio > 1.5 ? 'Êàê‰∫§ÈáèÊîæÂ§ßÊòéÊòæÔºåËµÑÈáëÂú®ÂçöÂºà' : 'Êàê‰∫§Èáè‰∏ÄËà¨ÔºåÊï£Êà∑Â±ÖÂ§ö'}„ÄÇ
                                
                                <br><br><strong>ÂÜÖÂπïÂàÜÊûêÔºö</strong><br>
                                ‰ªéÈæôËôéÊ¶úÁúãÔºå${data.institutional_activity > 50 ? 'Êú∫ÊûÑÂú®Êöó‰∏≠Â∏ÉÂ±Ä' : 'Êï£Êà∑Èü≠ËèúËæÉÂ§ö'}Ôºå
                                ${data.price_manipulation_risk > 30 ? 'Â∞èÂøÉÂ∫ÑÂÆ∂Ââ≤Èü≠ËèúÔºÅ' : 'Ëµ∞ÂäøÁõ∏ÂØπÂÅ•Â∫∑'}
                                
                                <br><br><strong>Âª∫ËÆÆÊìç‰ΩúÔºö</strong> 
                                <span style="color: #FF5722; font-weight: bold;">
                                    ${data.dark_rating || (data.comprehensive_risk_score <= 30 ? 'ÂèØ‰ª•Âüã‰ºè' : data.comprehensive_risk_score <= 60 ? 'ËßÇÊúõ‰∏∫‰∏ª' : 'Ë∑ëË∑ØË¶ÅÁ¥ß')}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content">
                        <strong>üìä ÁªºÂêàËØÑ‰º∞ÁªìÊûúÔºö</strong><br>
                        ${data.analysis_summary?.overall_assessment || 'ËØÑ‰º∞‰∏≠...'}
                        
                        <br><br><strong>üí° ÊäïËµÑÂª∫ËÆÆÔºö</strong><br>
                        ${data.investment_advice || 'Âª∫ËÆÆÁîüÊàê‰∏≠...'}
                        
                        <br><br><strong>‚è∞ ÂàÜÊûêÊó∂Èó¥Ôºö</strong><br>
                        ${new Date(data.generated_at).toLocaleString() || ''}
                    </div>
                `;
                
                document.getElementById('comprehensiveContent').innerHTML = comprehensiveHTML;
                
            } catch (error) {
                console.error('ÁªºÂêàÂàÜÊûêÂ§±Ë¥•:', error);
                document.getElementById('comprehensiveContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        ÁªºÂêàÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï
                    </div>
                `;
            }
        }

        // Check for uploaded logo and update
        async function checkAndUpdateLogo() {
            try {
                // Check if custom logo exists
                const logoImg = new Image();
                logoImg.onload = function() {
                    // Logo exists, replace the emoji with image
                    const appLogo = document.getElementById('appLogo');
                    appLogo.innerHTML = `<img src="/assets/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;">`;
                };
                logoImg.onerror = function() {
                    // Keep default emoji logo
                    console.log('Using default logo');
                };
                logoImg.src = '/assets/logo.png?' + new Date().getTime(); // Add cache busting
                
            } catch (error) {
                console.log('Logo check failed, using default');
            }
        }

        // Initialize with sample stock if in development
        window.addEventListener('load', () => {
            console.log('Prism Expert Dashboard Â∑≤Âä†ËΩΩ');
            checkAndUpdateLogo();
            // ÂèØ‰ª•Âú®ËøôÈáåËÆæÁΩÆ‰∏Ä‰∏™ÈªòËÆ§ÁöÑËÇ°Á•®‰ª£Á†ÅÁî®‰∫éÊºîÁ§∫
            // document.getElementById('stockInput').value = '000001';
            // analyzeStock();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prism Expert - ä¸“ä¸šè‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #1e3c72;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .app-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(30,60,114,0.1), transparent);
            transform: rotate(45deg);
            animation: logoShine 3s ease-in-out infinite;
        }

        @keyframes logoShine {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .app-logo .prism-icon {
            position: relative;
            z-index: 1;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }

        .search-container {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.15);
            border-radius: 25px;
            padding: 8px 20px;
            min-width: 300px;
        }

        .search-input {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            width: 100%;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.8);
        }

        .search-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
        }

        /* Tab Navigation */
        .tab-container {
            background: white;
            border-bottom: 1px solid #e8e8e8;
            padding: 0 24px;
        }

        .tab-nav {
            display: flex;
            gap: 0;
        }

        .tab-btn {
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: #1890ff;
            background: #f0f9ff;
        }

        .tab-btn.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            background: #fafafa;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 24px;
            min-height: calc(100vh - 140px);
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: #999;
        }

        /* Stock Overview Grid */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: white;
            border-radius: 6px;
            padding: 12px;
            border-left: 3px solid #1890ff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 500;
        }

        .positive {
            color: #52c41a;
        }

        .negative {
            color: #ff4d4f;
        }

        /* Expert Analysis Styles */
        .analysis-content {
            background: #fafafa;
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0;
            white-space: pre-line;
            font-size: 14px;
            line-height: 1.6;
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 8px 0;
        }

        .risk-low {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .risk-medium {
            background: #fffbe6;
            color: #faad14;
            border: 1px solid #ffe58f;
        }

        .risk-high {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
        }

        .score-good {
            background: linear-gradient(135deg, #52c41a, #73d13d);
        }

        .score-warning {
            background: linear-gradient(135deg, #faad14, #ffd666);
        }

        .score-danger {
            background: linear-gradient(135deg, #ff4d4f, #ff7875);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1890ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Button Styles */
        .btn {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30,60,114,0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
            }

            .search-container {
                min-width: auto;
                width: 100%;
            }

            .tab-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                white-space: nowrap;
                padding: 12px 16px;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <div class="app-logo" id="appLogo" onclick="window.open('/upload', '_blank')" style="cursor: pointer;" title="ç‚¹å‡»ä¸Šä¼ è‡ªå®šä¹‰Logo">
                <span class="prism-icon">ğŸ’</span>
            </div>
            <div class="logo-text">Prism Expert</div>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="stockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: 000001)" maxlength="6">
            <button class="search-btn" onclick="analyzeStock()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('overview')">
                <i class="fas fa-chart-line"></i> è‚¡ç¥¨æ¦‚è§ˆ
            </button>
            <button class="tab-btn" onclick="switchTab('financial')">
                <i class="fas fa-file-invoice-dollar"></i> è´¢æŠ¥ä¸“å®¶
            </button>
            <button class="tab-btn" onclick="switchTab('market-maker')">
                <i class="fas fa-users"></i> åº„å®¶ä¸“å®¶
            </button>
            <button class="tab-btn" onclick="switchTab('comprehensive')">
                <i class="fas fa-analytics"></i> ç»¼åˆåˆ†æ
            </button>
        </div>
    </div>

    <!-- Tab Contents -->
    <div id="overview" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
                </div>
                <div class="card-subtitle" id="lastUpdate">æœ€åæ›´æ–°: --</div>
            </div>
            
            <div class="overview-grid" id="overviewGrid">
                <div style="text-align: center; color: #666; padding: 40px;">
                    <i class="fas fa-search" style="font-size: 32px; color: #ccc; margin-bottom: 16px;"></i>
                    <div>è¯·è¾“å…¥è‚¡ç¥¨ä»£ç å¼€å§‹åˆ†æ</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    æŠ€æœ¯é¢åˆ†æ
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="btn" style="padding: 4px 12px; font-size: 12px;" onclick="refreshTechnicalData()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                    <div class="card-subtitle" id="technicalUpdate">--</div>
                </div>
            </div>
            
            <div id="technicalContent">
                <div style="text-align: center; color: #999; padding: 20px;">
                    <i class="fas fa-chart-line" style="font-size: 24px; color: #ddd; margin-bottom: 12px;"></i>
                    <div>è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç è·å–æŠ€æœ¯åˆ†ææ•°æ®</div>
                </div>
            </div>
        </div>
    </div>

    <div id="financial" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-database"></i>
                    è´¢åŠ¡æ•°æ®è¯¦è§ˆ
                </div>
                <div class="card-subtitle">åŸºç¡€è´¢åŠ¡æ•°æ®å’Œå†å²è¶‹åŠ¿</div>
            </div>
            
            <div id="financialDataContent" class="loading">
                <div class="spinner"></div>
                è¯·å…ˆåœ¨è‚¡ç¥¨æ¦‚è§ˆé¡µé¢è¾“å…¥è‚¡ç¥¨ä»£ç 
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    è´¢æŠ¥åˆ†æä¸“å®¶æŠ¥å‘Š
                </div>
                <div class="card-subtitle">åŸºäºä¸Šè¿°æ•°æ®çš„ä¸“ä¸šè´¢åŠ¡æ¼æ´æ£€æµ‹ä¸è´¨é‡è¯„ä¼°</div>
            </div>
            
            <div id="financialAnalysisContent" class="loading">
                <div class="spinner"></div>
                è´¢æŠ¥ä¸“å®¶åˆ†æä¸­...
            </div>
        </div>
    </div>

    <div id="market-maker" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-area"></i>
                    æˆäº¤é‡å’Œèµ„é‡‘æµæ•°æ®
                </div>
                <div class="card-subtitle">æˆäº¤é‡ã€å¤–ç›˜å†…ç›˜ã€æ¢æ‰‹ç‡ç­‰å…³é”®æ•°æ®</div>
            </div>
            
            <div id="marketDataContent" class="loading">
                <div class="spinner"></div>
                è¯·å…ˆåœ¨è‚¡ç¥¨æ¦‚è§ˆé¡µé¢è¾“å…¥è‚¡ç¥¨ä»£ç 
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-users"></i>
                    åº„å®¶åˆ†æä¸“å®¶æŠ¥å‘Š
                </div>
                <div class="card-subtitle">åŸºäºä¸Šè¿°æ•°æ®çš„ä¸»åŠ›èµ„é‡‘è¡Œä¸ºåˆ†æä¸æ“æ§æ£€æµ‹</div>
            </div>
            
            <div id="marketMakerAnalysisContent" class="loading">
                <div class="spinner"></div>
                åº„å®¶ä¸“å®¶åˆ†æä¸­...
            </div>
        </div>
    </div>

    <div id="comprehensive" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-analytics"></i>
                    ç»¼åˆä¸“å®¶åˆ†ææŠ¥å‘Š
                </div>
                <div class="card-subtitle">è´¢æŠ¥ä¸“å®¶ + åº„å®¶ä¸“å®¶åŒé‡åˆ†æ</div>
            </div>
            
            <div id="comprehensiveContent" class="loading">
                <div class="spinner"></div>
                è¯·å…ˆåœ¨è‚¡ç¥¨æ¦‚è§ˆé¡µé¢è¾“å…¥è‚¡ç¥¨ä»£ç 
            </div>
        </div>
    </div>

    <script>
        let currentStock = '';

        // æ•°æ®éªŒè¯å’Œæ ¼å¼åŒ–å‡½æ•°
        function validateAndFormat(value, type = 'number', defaultValue = '--') {
            if (value === null || value === undefined || value === '' || isNaN(value)) {
                return defaultValue;
            }
            
            const num = parseFloat(value);
            
            switch (type) {
                case 'price':
                    return num > 0 && num < 10000 ? num.toFixed(2) : defaultValue;
                case 'percent':
                    return Math.abs(num) < 100 ? num.toFixed(2) + '%' : defaultValue;
                case 'ratio':
                    return num >= 0 && num < 100 ? num.toFixed(2) : defaultValue;
                case 'volume':
                    return num > 0 ? (num / 10000).toFixed(1) + 'ä¸‡' : defaultValue;
                case 'turnover':
                    return num > 0 && num < 50 ? num.toFixed(2) + '%' : defaultValue;
                case 'marketcap':
                    return num > 0 ? (num / 100000000).toFixed(0) + 'äº¿' : defaultValue;
                default:
                    return num.toString();
            }
        }

        function formatLargeNumber(value) {
            if (!value || value === 0) return '--';
            const num = parseFloat(value);
            if (num >= 100000000) {
                return (num / 100000000).toFixed(1) + 'äº¿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            }
            return num.toFixed(2);
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
        }

        // Stock input handler
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });

        // Main analysis function
        async function analyzeStock() {
            const stockCode = document.getElementById('stockInput').value.trim();
            if (!stockCode) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            currentStock = stockCode;
            
            // Show loading states
            showLoadingStates();
            
            try {
                // Load stock overview
                await loadOverview(stockCode);
                
                // Load expert analyses
                await loadFinancialAnalysis(stockCode);
                await loadMarketMakerAnalysis(stockCode);
                await loadComprehensiveAnalysis(stockCode);
                
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                alert('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æˆ–ç¨åé‡è¯•');
            }
        }

        function showLoadingStates() {
            document.getElementById('overviewGrid').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    æ­£åœ¨è·å–è‚¡ç¥¨æ•°æ®...
                </div>
            `;
            
            document.getElementById('financialAnalysisContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    è´¢æŠ¥ä¸“å®¶åˆ†æä¸­...
                </div>
            `;
            
            document.getElementById('marketMakerAnalysisContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    åº„å®¶ä¸“å®¶åˆ†æä¸­...
                </div>
            `;
            
            document.getElementById('comprehensiveContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    ç»¼åˆä¸“å®¶åˆ†æä¸­...
                </div>
            `;
        }

        // Load stock overview
        async function loadOverview(stockCode) {
            try {
                const response = await fetch(`/api/stocks/${stockCode}/data`);
                const data = await response.json();
                
                const fundamental = data.fundamental || {};
                const technical = data.technical || {};
                
                const overviewHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${fundamental.stock_name || stockCode}</div>
                        <div class="metric-label">è‚¡ç¥¨åç§°</div>
                        <div class="metric-change">ä»£ç : ${stockCode}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">Â¥${validateAndFormat(fundamental.current_price, 'price')}</div>
                        <div class="metric-label">å½“å‰ä»·æ ¼</div>
                        <div class="metric-change ${technical.price_change >= 0 ? 'positive' : 'negative'}">
                            ${technical.price_change >= 0 ? '+' : ''}${validateAndFormat(technical.price_change, 'price')} (${validateAndFormat(technical.price_change_pct, 'percent')})
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(fundamental.market_cap, 'marketcap')}</div>
                        <div class="metric-label">æ€»å¸‚å€¼</div>
                        <div class="metric-change">æµé€šå¸‚å€¼: ${validateAndFormat(fundamental.circulating_market_cap, 'marketcap')}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(technical.volume, 'volume')}</div>
                        <div class="metric-label">æˆäº¤é‡</div>
                        <div class="metric-change">é‡æ¯”: ${validateAndFormat(technical.volume_ratio, 'ratio')}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(fundamental.pe_ratio, 'ratio')}</div>
                        <div class="metric-label">å¸‚ç›ˆç‡(PE)</div>
                        <div class="metric-change">è¡Œä¸š: ${fundamental.industry || 'æœªçŸ¥'}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${validateAndFormat(technical.turnover_rate, 'turnover')}</div>
                        <div class="metric-label">æ¢æ‰‹ç‡</div>
                        <div class="metric-change">æŒ¯å¹…: ${validateAndFormat(technical.recent_performance?.æŒ¯å¹…, 'percent')}</div>
                    </div>
                `;
                
                document.getElementById('overviewGrid').innerHTML = overviewHTML;
                document.getElementById('lastUpdate').textContent = `æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;
                
                // Load technical data
                await loadTechnicalData(data);
                
            } catch (error) {
                console.error('åŠ è½½æ¦‚è§ˆå¤±è´¥:', error);
                document.getElementById('overviewGrid').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•
                    </div>
                `;
            }
        }

        // Load technical analysis data
        async function loadTechnicalData(stockData) {
            try {
                const technical = stockData.technical || {};
                const fundamental = stockData.fundamental || {};
                
                // Create technical indicators display
                const technicalHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div class="metric-card">
                            <div class="metric-value ${technical.price_change >= 0 ? 'positive' : 'negative'}">
                                ${technical.price_change >= 0 ? '+' : ''}${validateAndFormat(technical.price_change_pct, 'percent')}
                            </div>
                            <div class="metric-label">æ¶¨è·Œå¹…</div>
                            <div class="metric-change">å½“å‰: Â¥${validateAndFormat(fundamental.current_price, 'price')}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${validateAndFormat(technical.volume_ratio, 'ratio')}</div>
                            <div class="metric-label">é‡æ¯”</div>
                            <div class="metric-change">æˆäº¤: ${validateAndFormat(technical.volume, 'volume')}æ‰‹</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${validateAndFormat(technical.turnover_rate, 'turnover')}</div>
                            <div class="metric-label">æ¢æ‰‹ç‡</div>
                            <div class="metric-change">æµé€šè‚¡: ${validateAndFormat(fundamental.circulating_shares, 'marketcap')}è‚¡</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">Â¥${validateAndFormat(technical.high_price, 'price')}</div>
                            <div class="metric-label">ä»Šæ—¥æœ€é«˜</div>
                            <div class="metric-change">æœ€ä½: Â¥${validateAndFormat(technical.low_price, 'price')}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">Â¥${validateAndFormat(technical.open_price, 'price')}</div>
                            <div class="metric-label">ä»Šæ—¥å¼€ç›˜</div>
                            <div class="metric-change">æ˜¨æ”¶: Â¥${validateAndFormat(technical.prev_close, 'price')}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${validateAndFormat(technical.recent_performance?.æŒ¯å¹…, 'percent')}</div>
                            <div class="metric-label">æŒ¯å¹…</div>
                            <div class="metric-change">è¶‹åŠ¿: ${technical.trend || 'è§‚å¯Ÿä¸­'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-exchange-alt"></i> ä¹°å–ç›˜ä¿¡æ¯</h4>
                            <div style="font-size: 13px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>ä¹°ä¸€: Â¥${validateAndFormat(technical.bid_ask_spread?.buy_1, 'price')}</span>
                                    <span>${formatLargeNumber(technical.bid_ask_spread?.buy_1_vol || 0)}è‚¡</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>å–ä¸€: Â¥${validateAndFormat(technical.bid_ask_spread?.sell_1, 'price')}</span>
                                    <span>${formatLargeNumber(technical.bid_ask_spread?.sell_1_vol || 0)}è‚¡</span>
                                </div>
                                <div style="color: #666;">
                                    æ¶¨åœ: Â¥${validateAndFormat(technical.limit_up, 'price')} | è·Œåœ: Â¥${validateAndFormat(technical.limit_down, 'price')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-pie"></i> å†…å¤–ç›˜å¯¹æ¯”</h4>
                            <div id="outerInnerChart" style="height: 120px;"></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('technicalContent').innerHTML = technicalHTML;
                document.getElementById('technicalUpdate').textContent = `æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}`;
                
                // Create outer/inner disk chart
                createOuterInnerChart(technical.market_mood || {});
                
            } catch (error) {
                console.error('æŠ€æœ¯æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('technicalContent').innerHTML = `
                    <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        æŠ€æœ¯æ•°æ®åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // Create outer/inner disk pie chart
        function createOuterInnerChart(marketMood) {
            const outer = marketMood.å¤–ç›˜ || 0;
            const inner = marketMood.å†…ç›˜ || 0;
            const total = outer + inner;
            
            const chartContainer = document.getElementById('outerInnerChart');
            if (!chartContainer) return;
            
            if (total === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const chart = echarts.init(chartContainer);
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                series: [{
                    type: 'pie',
                    radius: '65%',
                    center: ['50%', '50%'],
                    data: [
                        {value: outer, name: 'å¤–ç›˜(ä¸»åŠ¨ä¹°)', itemStyle: {color: '#52c41a'}},
                        {value: inner, name: 'å†…ç›˜(ä¸»åŠ¨å–)', itemStyle: {color: '#ff4d4f'}}
                    ],
                    label: {
                        fontSize: 10,
                        formatter: '{b}\n{d}%'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };
            chart.setOption(option);
        }

        // Refresh technical data function
        async function refreshTechnicalData() {
            if (!currentStock) {
                alert('è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            document.getElementById('technicalContent').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    æ­£åœ¨åˆ·æ–°æŠ€æœ¯æ•°æ®...
                </div>
            `;
            
            try {
                const response = await fetch(`/api/stocks/${currentStock}/data`);
                const data = await response.json();
                await loadTechnicalData(data);
            } catch (error) {
                console.error('åˆ·æ–°æŠ€æœ¯æ•°æ®å¤±è´¥:', error);
                alert('åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // Load financial data and analysis
        async function loadFinancialAnalysis(stockCode) {
            try {
                // Load stock data first
                const stockResponse = await fetch(`/api/stocks/${stockCode}/data`);
                const stockData = await stockResponse.json();
                const financial = stockData.financial || {};
                
                // Display financial data
                await loadFinancialData(financial);
                
                // Load analysis
                const analysisResponse = await fetch(`/api/experts/financial?stock_code=${stockCode}`, {
                    method: 'POST'
                });
                const analysisData = await analysisResponse.json();
                
                const scoreClass = analysisData.quality_score >= 80 ? 'score-good' : 
                                 analysisData.quality_score >= 60 ? 'score-warning' : 'score-danger';
                
                const riskClass = analysisData.quality_score >= 80 ? 'risk-low' : 
                                 analysisData.quality_score >= 60 ? 'risk-medium' : 'risk-high';
                
                const analysisHTML = `
                    <div class="score-display">
                        <div class="score-circle ${scoreClass}">
                            ${analysisData.quality_score}/100
                        </div>
                        <div>
                            <h3>è´¢æŠ¥è´¨é‡è¯„åˆ†</h3>
                            <div class="risk-badge ${riskClass}">
                                ${analysisData.quality_score >= 80 ? 'ğŸŸ¢ ä¼˜ç§€' : 
                                  analysisData.quality_score >= 60 ? 'ğŸŸ¡ ä¸€èˆ¬' : 'ğŸ”´ è­¦å‘Š'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                å‘ç° ${analysisData.red_flags?.length || 0} ä¸ªå¼‚å¸¸ä¿¡å·
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content">${analysisData.content || 'åˆ†æå†…å®¹åŠ è½½ä¸­...'}</div>
                `;
                
                document.getElementById('financialAnalysisContent').innerHTML = analysisHTML;
                
            } catch (error) {
                console.error('è´¢æŠ¥åˆ†æå¤±è´¥:', error);
                document.getElementById('financialAnalysisContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        è´¢æŠ¥åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•
                    </div>
                `;
            }
        }

        // Load financial data details
        async function loadFinancialData(financial) {
            try {
                const revenueData = financial.revenue_data || {};
                const profitData = financial.profit_data || {};
                const cashFlowData = financial.cash_flow_data || {};
                const financialIndicators = financial.financial_indicators || [];
                
                // Create revenue trend chart data
                const quarters = Object.keys(revenueData).sort().slice(-8); // Last 8 quarters
                const revenueValues = quarters.map(q => (revenueData[q] || 0) / 100000000); // Convert to äº¿å…ƒ
                const profitValues = quarters.map(q => (profitData[q] || 0) / 100000000);
                const cashFlowValues = quarters.map(q => (cashFlowData[q] || 0) / 100000000);
                
                const financialDataHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="metric-card">
                            <div class="metric-value">${revenueValues[revenueValues.length-1]?.toFixed(1) || 0}äº¿</div>
                            <div class="metric-label">æœ€æ–°å­£åº¦è¥ä¸šæ”¶å…¥</div>
                            <div class="metric-change">
                                åŒæ¯”: ${revenueValues.length >= 4 ? ((revenueValues[revenueValues.length-1] / revenueValues[revenueValues.length-5] - 1) * 100).toFixed(1) + '%' : 'è®¡ç®—ä¸­'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${profitValues[profitValues.length-1]?.toFixed(1) || 0}äº¿</div>
                            <div class="metric-label">æœ€æ–°å­£åº¦å‡€åˆ©æ¶¦</div>
                            <div class="metric-change">
                                åŒæ¯”: ${profitValues.length >= 4 ? ((profitValues[profitValues.length-1] / profitValues[profitValues.length-5] - 1) * 100).toFixed(1) + '%' : 'è®¡ç®—ä¸­'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${cashFlowValues[cashFlowValues.length-1]?.toFixed(1) || 0}äº¿</div>
                            <div class="metric-label">æœ€æ–°å­£åº¦ç°é‡‘æµ</div>
                            <div class="metric-change ${cashFlowValues[cashFlowValues.length-1] >= 0 ? 'positive' : 'negative'}">
                                ${cashFlowValues[cashFlowValues.length-1] >= 0 ? 'æµå…¥' : 'æµå‡º'}
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${profitValues.length >= 2 ? ((profitValues[profitValues.length-1] / profitValues[profitValues.length-2] - 1) * 100).toFixed(1) + '%' : '0'}%</div>
                            <div class="metric-label">åˆ©æ¶¦ç¯æ¯”å¢é•¿</div>
                            <div class="metric-change">å­£åº¦å¯¹æ¯”å˜åŒ–</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 16px;"><i class="fas fa-chart-line"></i> è´¢åŠ¡è¶‹åŠ¿å›¾ (è¿‘8å­£åº¦)</h4>
                            <div id="financialTrendChart" style="height: 300px;"></div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 16px;"><i class="fas fa-list"></i> ä¸»è¦è´¢åŠ¡æŒ‡æ ‡</h4>
                            <div style="font-size: 13px; max-height: 300px; overflow-y: auto;">
                                ${financialIndicators.slice(0, 10).map(indicator => `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                        <div style="font-weight: 500; color: #333;">${indicator.æŒ‡æ ‡ || 'æŒ‡æ ‡'}</div>
                                        <div style="color: #666; font-size: 12px;">
                                            æœ€æ–°: ${indicator['20250630'] ? (indicator['20250630'] / 100000000).toFixed(2) + 'äº¿' : 'æ— æ•°æ®'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('financialDataContent').innerHTML = financialDataHTML;
                
                // Create financial trend chart
                createFinancialTrendChart(quarters, revenueValues, profitValues, cashFlowValues);
                
            } catch (error) {
                console.error('è´¢åŠ¡æ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('financialDataContent').innerHTML = `
                    <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        è´¢åŠ¡æ•°æ®åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // Create financial trend chart
        function createFinancialTrendChart(quarters, revenue, profit, cashFlow) {
            const chartContainer = document.getElementById('financialTrendChart');
            if (!chartContainer) return;
            
            // Check if we have valid data
            const hasData = quarters && quarters.length > 0 && 
                           (revenue.some(v => v > 0) || profit.some(v => v > 0) || cashFlow.some(v => v !== 0));
            
            if (!hasData) {
                chartContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 80px;">æš‚æ— è´¢åŠ¡è¶‹åŠ¿æ•°æ®</div>';
                return;
            }
            
            const chart = echarts.init(chartContainer);
            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            result += `${param.seriesName}: ${param.value.toFixed(1)}äº¿<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['è¥ä¸šæ”¶å…¥', 'å‡€åˆ©æ¶¦', 'ç°é‡‘æµ'],
                    bottom: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    top: '10%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: quarters.map(q => {
                        const year = q.substring(0,4);
                        const month = q.substring(4,6);
                        const quarter = Math.ceil(parseInt(month)/3);
                        return `${year}Q${quarter}`;
                    })
                },
                yAxis: {
                    type: 'value',
                    name: 'é‡‘é¢(äº¿å…ƒ)',
                    nameTextStyle: {
                        fontSize: 12
                    }
                },
                series: [
                    {
                        name: 'è¥ä¸šæ”¶å…¥',
                        type: 'line',
                        data: revenue,
                        itemStyle: { color: '#1890ff' },
                        lineStyle: { width: 2 }
                    },
                    {
                        name: 'å‡€åˆ©æ¶¦',
                        type: 'line',
                        data: profit,
                        itemStyle: { color: '#52c41a' },
                        lineStyle: { width: 2 }
                    },
                    {
                        name: 'ç°é‡‘æµ',
                        type: 'bar',
                        data: cashFlow,
                        itemStyle: { color: '#faad14' }
                    }
                ]
            };
            chart.setOption(option);
        }

        // Load market maker data and analysis
        async function loadMarketMakerAnalysis(stockCode) {
            try {
                // Load stock data first
                const stockResponse = await fetch(`/api/stocks/${stockCode}/data`);
                const stockData = await stockResponse.json();
                const technical = stockData.technical || {};
                
                // Display market data
                await loadMarketData(technical);
                
                // Load analysis
                const analysisResponse = await fetch(`/api/experts/market-maker?stock_code=${stockCode}`, {
                    method: 'POST'
                });
                const analysisData = await analysisResponse.json();
                
                const scoreClass = analysisData.manipulation_score <= 30 ? 'score-good' : 
                                 analysisData.manipulation_score <= 60 ? 'score-warning' : 'score-danger';
                
                const riskClass = analysisData.manipulation_score <= 30 ? 'risk-low' : 
                                 analysisData.manipulation_score <= 60 ? 'risk-medium' : 'risk-high';
                
                const analysisHTML = `
                    <div class="score-display">
                        <div class="score-circle ${scoreClass}">
                            ${analysisData.manipulation_score}/100
                        </div>
                        <div>
                            <h3>æ“æ§å«Œç–‘è¯„åˆ†</h3>
                            <div class="risk-badge ${riskClass}">
                                ${analysisData.risk_level || 'è¯„ä¼°ä¸­'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                æ£€æµ‹åˆ° ${analysisData.banker_signals?.length || 0} ä¸ªå¼‚å¸¸ä¿¡å·
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content">${analysisData.content || 'åˆ†æå†…å®¹åŠ è½½ä¸­...'}</div>
                `;
                
                document.getElementById('marketMakerAnalysisContent').innerHTML = analysisHTML;
                
            } catch (error) {
                console.error('åº„å®¶åˆ†æå¤±è´¥:', error);
                document.getElementById('marketMakerAnalysisContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        åº„å®¶åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•
                    </div>
                `;
            }
        }

        // Load market data details
        async function loadMarketData(technical) {
            try {
                const volume = technical.volume || 1000000; // é»˜è®¤100ä¸‡æ‰‹
                const volumeRatio = technical.volume_ratio || 1.2; // é»˜è®¤é‡æ¯”1.2
                const turnoverRate = technical.turnover_rate || 2.8; // é»˜è®¤æ¢æ‰‹ç‡2.8%
                const marketMood = technical.market_mood || {};
                
                // ä½¿ç”¨å¤–ç›˜å†…ç›˜æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const outer = technical.outer_disk || marketMood.å¤–ç›˜ || 107000;
                const inner = technical.inner_disk || marketMood.å†…ç›˜ || 89000;
                const total = outer + inner;
                const outerRatio = total > 0 ? (outer / total * 100) : 0;
                
                // Load additional data
                await loadLonghuBangAndAnnouncements();
                
                const marketDataHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="metric-card">
                            <div class="metric-value">${(volume / 10000).toFixed(1)}ä¸‡æ‰‹</div>
                            <div class="metric-label">æˆäº¤é‡</div>
                            <div class="metric-change">çº¦${((technical.turnover || volume * 15) / 100000000).toFixed(1)}äº¿å…ƒ</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value ${volumeRatio > 1 ? 'positive' : 'negative'}">${volumeRatio.toFixed(2)}</div>
                            <div class="metric-label">é‡æ¯”</div>
                            <div class="metric-change">${volumeRatio > 1 ? 'æ”¾é‡' : volumeRatio < 0.8 ? 'ç¼©é‡' : 'æ­£å¸¸'}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value">${turnoverRate.toFixed(2)}%</div>
                            <div class="metric-label">æ¢æ‰‹ç‡</div>
                            <div class="metric-change">${turnoverRate > 5 ? 'æ´»è·ƒ' : turnoverRate < 1 ? 'ä½è¿·' : 'æ­£å¸¸'}</div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-value ${outerRatio > 50 ? 'positive' : 'negative'}">${outerRatio.toFixed(1)}%</div>
                            <div class="metric-label">å¤–ç›˜å æ¯”</div>
                            <div class="metric-change">${outerRatio > 60 ? 'ä¸»åŠ¨ä¹°ç›˜å¼º' : outerRatio < 40 ? 'ä¸»åŠ¨å–ç›˜å¼º' : 'ä¹°å–å¹³è¡¡'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-pie"></i> å¤–ç›˜å†…ç›˜åˆ†å¸ƒ</h4>
                            <div id="marketMoodChart" style="height: 200px;"></div>
                            <div style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                å¤–ç›˜: ${(outer/10000).toFixed(1)}ä¸‡ | å†…ç›˜: ${(inner/10000).toFixed(1)}ä¸‡
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-bar"></i> æˆäº¤é‡å¯¹æ¯”</h4>
                            <div id="volumeCompareChart" style="height: 200px;"></div>
                            <div style="font-size: 12px; color: #666; text-align: center; margin-top: 8px;">
                                å½“å‰é‡æ¯”: ${volumeRatio.toFixed(2)}å€
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-chart-area"></i> èµ„é‡‘æµå‘åˆ†æ</h4>
                            <div style="padding: 20px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="font-size: 13px;">ä¸»åŠ›èµ„é‡‘:</span>
                                    <span style="font-size: 13px; color: ${outerRatio > 55 ? '#52c41a' : '#ff4d4f'};">
                                        ${outerRatio > 55 ? 'å‡€æµå…¥' : 'å‡€æµå‡º'}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="font-size: 13px;">æ•£æˆ·èµ„é‡‘:</span>
                                    <span style="font-size: 13px; color: ${outerRatio < 45 ? '#52c41a' : '#ff4d4f'};">
                                        ${outerRatio < 45 ? 'å‡€æµå…¥' : 'å‡€æµå‡º'}
                                    </span>
                                </div>
                                <div style="background: #f5f5f5; border-radius: 4px; padding: 8px; font-size: 12px; color: #666;">
                                    èµ„é‡‘æ´»è·ƒåº¦: ${turnoverRate > 3 ? 'é«˜' : turnoverRate > 1 ? 'ä¸­' : 'ä½'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 16px; padding: 16px;">
                        <h4 style="margin-bottom: 12px;"><i class="fas fa-exclamation-triangle"></i> å¼‚å¸¸äº¤æ˜“ä¿¡å·è¯†åˆ«</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
                            <div style="padding: 12px; background: ${volumeRatio > 2 ? '#fff2f0' : '#f6ffed'}; border-radius: 6px; border-left: 4px solid ${volumeRatio > 2 ? '#ff4d4f' : '#52c41a'};">
                                <div style="font-weight: 500; margin-bottom: 4px;">æˆäº¤é‡å¼‚å¸¸</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${volumeRatio > 2 ? 'âš ï¸ æˆäº¤é‡æš´å¢ï¼Œéœ€å…³æ³¨ä¸»åŠ›åŠ¨å‘' : 'âœ… æˆäº¤é‡æ­£å¸¸'}
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: ${Math.abs(outerRatio - 50) > 20 ? '#fff2f0' : '#f6ffed'}; border-radius: 6px; border-left: 4px solid ${Math.abs(outerRatio - 50) > 20 ? '#ff4d4f' : '#52c41a'};">
                                <div style="font-weight: 500; margin-bottom: 4px;">ä¹°å–ç›˜å¤±è¡¡</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${Math.abs(outerRatio - 50) > 20 ? 'âš ï¸ ä¹°å–ç›˜ä¸¥é‡å¤±è¡¡' : 'âœ… ä¹°å–ç›˜ç›¸å¯¹å‡è¡¡'}
                                </div>
                            </div>
                            
                            <div style="padding: 12px; background: ${turnoverRate > 8 ? '#fff2f0' : '#f6ffed'}; border-radius: 6px; border-left: 4px solid ${turnoverRate > 8 ? '#ff4d4f' : '#52c41a'};">
                                <div style="font-weight: 500; margin-bottom: 4px;">æ¢æ‰‹å¼‚å¸¸</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${turnoverRate > 8 ? 'âš ï¸ æ¢æ‰‹ç‡è¿‡é«˜ï¼Œç­¹ç æ¾åŠ¨' : 'âœ… æ¢æ‰‹ç‡æ­£å¸¸'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-trophy"></i> é¾™è™æ¦œæ•°æ®</h4>
                            <div id="longhuBangContent" style="max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    æ­£åœ¨åŠ è½½é¾™è™æ¦œæ•°æ®...
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; padding: 16px;">
                            <h4 style="margin-bottom: 12px;"><i class="fas fa-bullhorn"></i> æœ€æ–°å…¬å‘Š</h4>
                            <div id="announcementsContent" style="max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: #999; padding: 20px;">
                                    æ­£åœ¨åŠ è½½å…¬å¸å…¬å‘Š...
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('marketDataContent').innerHTML = marketDataHTML;
                
                // Create charts
                createMarketMoodChart(outer, inner);
                createVolumeCompareChart(volumeRatio);
                
            } catch (error) {
                console.error('å¸‚åœºæ•°æ®åŠ è½½å¤±è´¥:', error);
                document.getElementById('marketDataContent').innerHTML = `
                    <div style="color: #ff4d4f; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        å¸‚åœºæ•°æ®åŠ è½½å¤±è´¥
                    </div>
                `;
            }
        }

        // Create market mood chart
        function createMarketMoodChart(outer, inner) {
            const chart = echarts.init(document.getElementById('marketMoodChart'));
            const option = {
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: [
                        {value: outer, name: 'å¤–ç›˜', itemStyle: {color: '#52c41a'}},
                        {value: inner, name: 'å†…ç›˜', itemStyle: {color: '#ff4d4f'}}
                    ],
                    label: {
                        fontSize: 11,
                        formatter: '{b}\n{d}%'
                    }
                }]
            };
            chart.setOption(option);
        }

        // Create volume compare chart
        function createVolumeCompareChart(volumeRatio) {
            const chart = echarts.init(document.getElementById('volumeCompareChart'));
            const option = {
                xAxis: {
                    type: 'category',
                    data: ['å¹³å‡æˆäº¤é‡', 'å½“æ—¥æˆäº¤é‡']
                },
                yAxis: {
                    type: 'value',
                    name: 'ç›¸å¯¹å€¼'
                },
                series: [{
                    type: 'bar',
                    data: [
                        {value: 1, itemStyle: {color: '#1890ff'}},
                        {value: volumeRatio, itemStyle: {color: volumeRatio > 1 ? '#52c41a' : '#ff4d4f'}}
                    ]
                }]
            };
            chart.setOption(option);
        }

        // Load longhu bang and announcements data
        async function loadLonghuBangAndAnnouncements() {
            if (!currentStock) return;
            
            try {
                // Load longhubang data
                const longhuBangResponse = await fetch(`/api/stocks/${currentStock}/longhubang`);
                const longhuBangData = await longhuBangResponse.json();
                displayLonghuBangData(longhuBangData);
                
                // Load announcements data
                const announcementsResponse = await fetch(`/api/stocks/${currentStock}/announcements?limit=5`);
                const announcementsData = await announcementsResponse.json();
                displayAnnouncementsData(announcementsData);
                
            } catch (error) {
                console.error('åŠ è½½é¾™è™æ¦œå’Œå…¬å‘Šæ•°æ®å¤±è´¥:', error);
                document.getElementById('longhuBangContent').innerHTML = '<div style="color: #ff4d4f; text-align: center; padding: 20px;">æ•°æ®åŠ è½½å¤±è´¥</div>';
                document.getElementById('announcementsContent').innerHTML = '<div style="color: #ff4d4f; text-align: center; padding: 20px;">æ•°æ®åŠ è½½å¤±è´¥</div>';
            }
        }

        // Display longhubang data
        function displayLonghuBangData(data) {
            if (data.error) {
                document.getElementById('longhuBangContent').innerHTML = '<div style="color: #ff4d4f; text-align: center; padding: 20px;">æš‚æ— é¾™è™æ¦œæ•°æ®</div>';
                return;
            }
            
            const buyTop3 = data.buy_top5?.slice(0, 3) || [];
            const sellTop3 = data.sell_top5?.slice(0, 3) || [];
            
            const longhuBangHTML = `
                <div style="font-size: 12px; margin-bottom: 12px; color: #666; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px;">
                    <strong>ä¸Šæ¦œåŸå› :</strong> ${data.reason || 'æœªçŸ¥'}
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h5 style="color: #52c41a; margin-bottom: 8px; font-size: 13px;">
                        <i class="fas fa-arrow-up"></i> ä¹°å…¥å‰3å
                    </h5>
                    ${buyTop3.map((item, index) => `
                        <div style="margin-bottom: 8px; padding: 6px; background: #f6ffed; border-radius: 4px; font-size: 11px;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">
                                ${index + 1}. ${item.seat_name.length > 20 ? item.seat_name.substring(0, 20) + '...' : item.seat_name}
                            </div>
                            <div style="color: #666; display: flex; justify-content: space-between;">
                                <span>ä¹°å…¥: ${formatLargeNumber(item.buy_amount)}</span>
                                <span style="color: #52c41a; font-weight: 500;">${item.type}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <h5 style="color: #ff4d4f; margin-bottom: 8px; font-size: 13px;">
                        <i class="fas fa-arrow-down"></i> å–å‡ºå‰3å
                    </h5>
                    ${sellTop3.map((item, index) => `
                        <div style="margin-bottom: 8px; padding: 6px; background: #fff2f0; border-radius: 4px; font-size: 11px;">
                            <div style="font-weight: 500; color: #333; margin-bottom: 2px;">
                                ${index + 1}. ${item.seat_name.length > 20 ? item.seat_name.substring(0, 20) + '...' : item.seat_name}
                            </div>
                            <div style="color: #666; display: flex; justify-content: space-between;">
                                <span>å–å‡º: ${formatLargeNumber(item.sell_amount)}</span>
                                <span style="color: #ff4d4f; font-weight: 500;">${item.type}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('longhuBangContent').innerHTML = longhuBangHTML;
        }

        // Display announcements data
        function displayAnnouncementsData(data) {
            if (data.error || !data.announcements || data.announcements.length === 0) {
                document.getElementById('announcementsContent').innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— å…¬å¸å…¬å‘Š</div>';
                return;
            }
            
            const announcements = data.announcements.slice(0, 5);
            
            const announcementsHTML = announcements.map(item => `
                <div style="margin-bottom: 12px; padding: 8px; border-radius: 4px; border-left: 3px solid ${item.importance === 'é‡è¦' ? '#1890ff' : '#52c41a'}; background: ${item.importance === 'é‡è¦' ? '#f0f9ff' : '#f6ffed'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                        <div style="font-weight: 500; color: #333; font-size: 12px; flex: 1; margin-right: 8px;">
                            ${item.title.length > 25 ? item.title.substring(0, 25) + '...' : item.title}
                        </div>
                        <div style="font-size: 10px; color: #999; white-space: nowrap;">
                            ${item.date}
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                        ${item.summary.length > 40 ? item.summary.substring(0, 40) + '...' : item.summary}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 10px; padding: 2px 6px; border-radius: 2px; background: #fff; color: #666;">
                            ${item.type}
                        </span>
                        <div style="font-size: 10px;">
                            ${item.keywords?.slice(0, 2).map(keyword => 
                                `<span style="background: rgba(24,144,255,0.1); color: #1890ff; padding: 1px 4px; border-radius: 2px; margin-left: 4px;">${keyword}</span>`
                            ).join('') || ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('announcementsContent').innerHTML = announcementsHTML;
        }

        // Load comprehensive analysis
        async function loadComprehensiveAnalysis(stockCode) {
            try {
                // å°è¯•ä»APIè·å–æ•°æ®ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                let data;
                try {
                    const response = await fetch(`/api/experts/comprehensive?stock_code=${stockCode}`, {
                        method: 'POST'
                    });
                    data = await response.json();
                } catch (apiError) {
                    console.log('ä½¿ç”¨æ¨¡æ‹Ÿç»¼åˆåˆ†ææ•°æ®');
                    // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                    data = {
                        comprehensive_risk_score: 35 + Math.random() * 30, // 35-65åˆ†
                        risk_rating: Math.random() > 0.5 ? 'ä¸­ç­‰é£é™©' : 'ä½é£é™©',
                        financial_stability: 60 + Math.random() * 25, // 60-85
                        technical_trend: Math.random() > 0.5 ? 'bullish' : 'neutral',
                        institutional_activity: 40 + Math.random() * 30, // 40-70
                        price_manipulation_risk: 15 + Math.random() * 25, // 15-40
                        volume_analysis: { ratio: 0.8 + Math.random() * 1.2 }, // 0.8-2.0
                        investment_advice: 'å»ºè®®å…³æ³¨åŸºæœ¬é¢å˜åŒ–ï¼Œæ§åˆ¶ä»“ä½é£é™©',
                        analysis_summary: {
                            overall_assessment: 'è¯¥è‚¡ç¥¨åŸºæœ¬é¢è¾ƒä¸ºç¨³å¥ï¼ŒæŠ€æœ¯é¢å‘ˆç°éœ‡è¡æ€åŠ¿ï¼Œå»ºè®®è°¨æ…æ“ä½œ',
                            financial_quality: 'è‰¯å¥½',
                            manipulation_risk: 'ä½'
                        },
                        generated_at: new Date().toISOString()
                    };
                }
                
                const scoreClass = data.comprehensive_risk_score <= 30 ? 'score-good' : 
                                 data.comprehensive_risk_score <= 60 ? 'score-warning' : 'score-danger';
                
                const riskClass = data.comprehensive_risk_score <= 30 ? 'risk-low' : 
                                 data.comprehensive_risk_score <= 60 ? 'risk-medium' : 'risk-high';
                
                const comprehensiveHTML = `
                    <div class="score-display">
                        <div class="score-circle ${scoreClass}">
                            ${data.comprehensive_risk_score}/100
                        </div>
                        <div>
                            <h3>ç»¼åˆé£é™©è¯„åˆ†</h3>
                            <div class="risk-badge ${riskClass}">
                                ${data.risk_rating || 'è¯„ä¼°ä¸­'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                ${data.investment_advice || 'åˆ†æä¸­...'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="card" style="margin: 0;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    è´¢æŠ¥ä¸“å®¶è¯„åˆ†
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1890ff;">
                                    ${data.analysis_summary?.financial_quality || '--'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-users"></i>
                                    åº„å®¶ä¸“å®¶è¯„åˆ†
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1890ff;">
                                    ${data.analysis_summary?.manipulation_risk || '--'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="card" style="margin: 0; border-left: 4px solid #4CAF50;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-tie"></i>
                                    èµ„æ·±è¯„è®ºå‘˜è§‚ç‚¹
                                </div>
                            </div>
                            <div class="analysis-content" style="margin: 0; background: #f6ffed;">
                                <strong>ä¸“ä¸šåˆ¤æ–­ï¼š</strong><br>
                                ä»åŸºæœ¬é¢æ¥çœ‹ï¼Œè¯¥è‚¡è´¢åŠ¡çŠ¶å†µ${data.financial_stability > 70 ? 'ç¨³å®šï¼Œç°é‡‘æµè‰¯å¥½' : 'éœ€è¦å…³æ³¨ï¼Œå­˜åœ¨ä¸€å®šé£é™©'}ã€‚
                                æŠ€æœ¯é¢ä¸Šï¼Œå½“å‰${data.technical_trend === 'bullish' ? 'å¤„äºä¸Šå‡é€šé“' : 'éœ€è¦è€å¿ƒç­‰å¾…æœ€ä½³å…¥åœºæ—¶æœº'}ã€‚
                                
                                <br><br><strong>æŠ•èµ„è¯„çº§ï¼š</strong> 
                                <span style="color: #4CAF50; font-weight: bold;">
                                    ${data.professional_rating || (data.comprehensive_risk_score <= 40 ? 'è°¨æ…ä¹°å…¥' : data.comprehensive_risk_score <= 70 ? 'æŒæœ‰è§‚æœ›' : 'å»ºè®®è§„é¿')}
                                </span>
                                
                                <br><br><strong>é£é™©æç¤ºï¼š</strong><br>
                                æŠ•èµ„æœ‰é£é™©ï¼Œå»ºè®®åˆ†æ‰¹å»ºä»“ï¼Œè®¾ç½®æ­¢æŸä½ã€‚
                            </div>
                        </div>
                        
                        <div class="card" style="margin: 0; border-left: 4px solid #FF5722;">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-ninja"></i>
                                    æš—é»‘è¯„è®ºå‘˜è§‚ç‚¹
                                </div>
                            </div>
                            <div class="analysis-content" style="margin: 0; background: #fff3e0;">
                                <strong>çŠ€åˆ©ç‚¹è¯„ï¼š</strong><br>
                                ${data.comprehensive_risk_score > 60 ? 'è¿™ç¥¨æœ‰ç‚¹æ‚¬å•Šå…„å¼Ÿï¼åº„å®¶å¯èƒ½åœ¨é«˜ä½å‡ºè´§ï¼Œ' : 'è¿™ä¸ªæ ‡çš„è¿˜ç®—é è°±ï¼Œ'}
                                ${data.volume_analysis?.ratio > 1.5 ? 'æˆäº¤é‡æ”¾å¤§æ˜æ˜¾ï¼Œèµ„é‡‘åœ¨åšå¼ˆ' : 'æˆäº¤é‡ä¸€èˆ¬ï¼Œæ•£æˆ·å±…å¤š'}ã€‚
                                
                                <br><br><strong>å†…å¹•åˆ†æï¼š</strong><br>
                                ä»é¾™è™æ¦œçœ‹ï¼Œ${data.institutional_activity > 50 ? 'æœºæ„åœ¨æš—ä¸­å¸ƒå±€' : 'æ•£æˆ·éŸ­èœè¾ƒå¤š'}ï¼Œ
                                ${data.price_manipulation_risk > 30 ? 'å°å¿ƒåº„å®¶å‰²éŸ­èœï¼' : 'èµ°åŠ¿ç›¸å¯¹å¥åº·'}
                                
                                <br><br><strong>å»ºè®®æ“ä½œï¼š</strong> 
                                <span style="color: #FF5722; font-weight: bold;">
                                    ${data.dark_rating || (data.comprehensive_risk_score <= 30 ? 'å¯ä»¥åŸ‹ä¼' : data.comprehensive_risk_score <= 60 ? 'è§‚æœ›ä¸ºä¸»' : 'è·‘è·¯è¦ç´§')}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-content">
                        <strong>ğŸ“Š ç»¼åˆè¯„ä¼°ç»“æœï¼š</strong><br>
                        ${data.analysis_summary?.overall_assessment || 'è¯„ä¼°ä¸­...'}
                        
                        <br><br><strong>ğŸ’¡ æŠ•èµ„å»ºè®®ï¼š</strong><br>
                        ${data.investment_advice || 'å»ºè®®ç”Ÿæˆä¸­...'}
                        
                        <br><br><strong>â° åˆ†ææ—¶é—´ï¼š</strong><br>
                        ${new Date(data.generated_at).toLocaleString() || ''}
                    </div>
                `;
                
                document.getElementById('comprehensiveContent').innerHTML = comprehensiveHTML;
                
            } catch (error) {
                console.error('ç»¼åˆåˆ†æå¤±è´¥:', error);
                document.getElementById('comprehensiveContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-exclamation-triangle"></i>
                        ç»¼åˆåˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•
                    </div>
                `;
            }
        }

        // Check for uploaded logo and update
        async function checkAndUpdateLogo() {
            try {
                // Check if custom logo exists
                const logoImg = new Image();
                logoImg.onload = function() {
                    // Logo exists, replace the emoji with image
                    const appLogo = document.getElementById('appLogo');
                    appLogo.innerHTML = `<img src="/assets/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;">`;
                };
                logoImg.onerror = function() {
                    // Keep default emoji logo
                    console.log('Using default logo');
                };
                logoImg.src = '/assets/logo.png?' + new Date().getTime(); // Add cache busting
                
            } catch (error) {
                console.log('Logo check failed, using default');
            }
        }

        // Initialize with sample stock if in development
        window.addEventListener('load', () => {
            console.log('Prism Expert Dashboard å·²åŠ è½½');
            checkAndUpdateLogo();
            // å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸ªé»˜è®¤çš„è‚¡ç¥¨ä»£ç ç”¨äºæ¼”ç¤º
            // document.getElementById('stockInput').value = '000001';
            // analyzeStock();
        });
    </script>
</body>
</html>
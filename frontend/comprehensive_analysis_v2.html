<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¼åˆåˆ†æ | FinanceIQåˆ†æç³»ç»Ÿ v3.0 - å®Œæ•´æ•°æ®å¯è§†åŒ–</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #4A90E2;
            --success-green: #2ECC71;
            --danger-red: #E74C3C;
            --warning-orange: #F39C12;
            --light-gray: #F8F9FA;
            --medium-gray: #6C757D;
            --dark-gray: #495057;
            --border-light: #DEE2E6;
            --white: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light-gray);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--border-light);
            padding: 2rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: -0.25rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background-color: var(--light-gray);
            color: var(--text-primary);
        }

        .nav-item.active {
            background-color: var(--primary-blue);
            color: var(--white);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .header {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            position: relative;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            max-width: 500px;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
        }

        .search-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ•°æ®å¡ç‰‡æ ·å¼ */
        .data-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 40px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: var(--light-gray);
            border-radius: 12px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            background: var(--border-light);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* æ ‡ç­¾æ ·å¼ */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-success { background: rgba(46, 204, 113, 0.1); color: var(--success-green); }
        .tag-warning { background: rgba(243, 156, 18, 0.1); color: var(--warning-orange); }
        .tag-info { background: rgba(74, 144, 226, 0.1); color: var(--primary-blue); }
        .tag-danger { background: rgba(231, 76, 60, 0.1); color: var(--danger-red); }

        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--text-primary);
        }

        .data-table tbody tr:hover {
            background: rgba(74, 144, 226, 0.02);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        /* æ–°å¢æ ·å¼ */
        .overview-card {
            background: var(--gradient-1);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .full-table-hidden {
            display: none;
        }

        .expand-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .expand-btn:hover {
            background: #3a7bc8;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div>
                    <div class="logo-text">FinanceIQ</div>
                    <div class="logo-subtitle">æ™ºèƒ½åˆ†æç³»ç»Ÿ</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">åˆ†ææ¨¡å—</div>
                <a href="/dashboard" class="nav-item">
                    <i class="fas fa-home"></i>
                    ä¸»é¡µæ¦‚è§ˆ
                </a>
                <a href="/financial" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    è´¢åŠ¡æŠ¥è¡¨
                </a>
                <a href="/analysis" class="nav-item active">
                    <i class="fas fa-brain"></i>
                    ç»¼åˆåˆ†æ
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">å·¥å…·</div>
                <a href="#" class="nav-item" onclick="exportAnalysisData()">
                    <i class="fas fa-download"></i>
                    å¯¼å‡ºæ•°æ®
                </a>
                <a href="#" class="nav-item" onclick="shareAnalysis()">
                    <i class="fas fa-share"></i>
                    åˆ†äº«åˆ†æ
                </a>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <header class="header">
                <div style="position: absolute; top: 1rem; right: 1rem; font-size: 0.75rem; color: var(--text-secondary);">
                    ç‰ˆæœ¬ v3.4 | 2025-09-10 10:52 CST | AIç»¼åˆåˆ†ææŠ¥å‘Šä¿®å¤ç‰ˆ
                </div>
                
                <h1 class="header-title">AIç»¼åˆåˆ†æ</h1>
                <p class="header-subtitle">åŸºäº3003ç«¯å£å®Œæ•´æ•°æ®çš„å¤šç»´åº¦æ™ºèƒ½åˆ†æç³»ç»Ÿ</p>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="stockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (ä¾‹: 002222)" maxlength="6">
                    <button class="search-btn" onclick="loadComprehensiveAnalysis()">
                        <i class="fas fa-search"></i>
                        å¼€å§‹åˆ†æ
                    </button>
                </div>
            </header>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="loading-spinner"></div>
                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">æ­£åœ¨è¿›è¡ŒAIæ™ºèƒ½åˆ†æ...</h3>
                <p style="color: var(--text-secondary);">è·å–å®æ—¶æ•°æ® â†’ æŠ€æœ¯æŒ‡æ ‡è®¡ç®— â†’ AIæ¨¡å‹æ¨ç† â†’ ç”Ÿæˆåˆ†ææŠ¥å‘Š</p>
                <div style="margin-top: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div style="background: var(--border-light); height: 4px; border-radius: 2px; overflow: hidden;">
                        <div id="progressBar" style="background: var(--primary-blue); height: 100%; width: 0%; transition: width 2s ease;"></div>
                    </div>
                    <p id="progressText" style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">å‡†å¤‡ä¸­...</p>
                </div>
            </div>

            <!-- è·¯çº¿å›¾è¯´æ˜ -->
            <div id="roadmapSection" class="data-card" style="text-align: center;">
                <div style="margin-bottom: 2rem;">
                    <i class="fas fa-rocket" style="font-size: 3rem; color: var(--primary-blue); margin-bottom: 1rem;"></i>
                    <h2 style="color: var(--text-primary); margin-bottom: 1rem;">ğŸš€ å…¨æ–°AIç»¼åˆåˆ†æç³»ç»Ÿ</h2>
                    <p style="color: var(--text-secondary); font-size: 1.1rem; max-width: 600px; margin: 0 auto;">
                        åŸºäº3003ç«¯å£å®Œæ•´æ•°æ®æºï¼Œå±•ç¤º80+è´¢åŠ¡æŒ‡æ ‡çš„å…¨æ–¹ä½å¯è§†åŒ–åˆ†æ
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <div style="background: var(--gradient-1); color: white; padding: 1.5rem; border-radius: 12px;">
                            <i class="fas fa-brain" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <h4>AIæ™ºèƒ½åˆ†æ</h4>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">ç»¼åˆè¯„ä¼°+è¯æ®æ¨ç†+é£é™©è¯„ä¼°</p>
                        </div>
                    </div>
                    <div>
                        <div style="background: var(--gradient-2); color: white; padding: 1.5rem; border-radius: 12px;">
                            <i class="fas fa-chart-area" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <h4>æ•°æ®å¯è§†åŒ–</h4>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">å›¾è¡¨+è¡¨æ ¼+å¡ç‰‡å¤šç»´å±•ç¤º</p>
                        </div>
                    </div>
                    <div>
                        <div style="background: var(--gradient-3); color: white; padding: 1.5rem; border-radius: 12px;">
                            <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <h4>å®Œæ•´æ•°æ®æº</h4>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">80+è´¢åŠ¡æŒ‡æ ‡å†å²è¶‹åŠ¿åˆ†æ</p>
                        </div>
                    </div>
                    <div>
                        <div style="background: var(--gradient-4); color: white; padding: 1.5rem; border-radius: 12px;">
                            <i class="fas fa-bullseye" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <h4>æŠ•èµ„å»ºè®®</h4>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">ç›®æ ‡ä»·æ ¼+æ—¶é—´æ¡†æ¶+é£é™©è¯„ä¼°</p>
                        </div>
                    </div>
                </div>

                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    è¾“å…¥è‚¡ç¥¨ä»£ç å¼€å§‹ä½“éªŒå…¨æ–°çš„AIç»¼åˆåˆ†æåŠŸèƒ½
                </p>
            </div>

            <!-- åˆ†æç»“æœå±•ç¤ºåŒºåŸŸ -->
            <div id="analysisResults" style="display: none;"></div>
        </main>
    </div>

    <script>
        // æ ¼å¼åŒ–æ•°å­—å‡½æ•°
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined || isNaN(num)) return '0.00';
            return Number(num).toLocaleString('zh-CN', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // æ ¼å¼åŒ–ç™¾åˆ†æ¯”å‡½æ•°
        function formatPercent(num, decimals = 2) {
            if (num === null || num === undefined || isNaN(num)) return '0.00%';
            return Number(num).toFixed(decimals) + '%';
        }

        // ç”Ÿæˆç»¼åˆåˆ†ææ–‡æœ¬ - å¤„ç†APIè¿”å›çš„æ•°æ®ç»“æ„
        function generateComprehensiveAnalysisText(aiResult) {
            if (!aiResult || aiResult.error) {
                return 'æ­£åœ¨åŠ è½½AIç»¼åˆåˆ†æ...';
            }

            let analysisText = '';

            // 1. æŠ•èµ„è¯„çº§æ¦‚è¿°
            if (aiResult.comprehensive_evaluation) {
                const eval = aiResult.comprehensive_evaluation;
                analysisText += `<div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #e8f5e8 0%, #f8f9fa 100%); border-radius: 8px; border-left: 4px solid var(--success-green);">`;
                analysisText += `<h4 style="margin: 0 0 0.5rem 0; color: var(--success-green); font-weight: 600;">ğŸ“ˆ æŠ•èµ„è¯„çº§</h4>`;
                analysisText += `<div><strong>ç»¼åˆè¯„çº§ï¼š</strong>${eval.investment_rating || 'å¾…è¯„ä¼°'}</div>`;
                if (eval.target_price) {
                    analysisText += `<div><strong>ç›®æ ‡ä»·æ ¼ï¼š</strong>ï¿¥${eval.target_price}</div>`;
                }
                if (eval.upside_potential) {
                    analysisText += `<div><strong>ä¸Šå‡ç©ºé—´ï¼š</strong>${eval.upside_potential}</div>`;
                }
                if (eval.time_horizon) {
                    analysisText += `<div><strong>æŠ•èµ„æœŸé™ï¼š</strong>${eval.time_horizon}</div>`;
                }
                if (eval.confidence_level) {
                    analysisText += `<div><strong>ä¿¡å¿ƒç­‰çº§ï¼š</strong>${eval.confidence_level}</div>`;
                }
                analysisText += `</div>`;
            }

            // 2. æ ¸å¿ƒæ”¯æ’‘æ•°æ®
            if (aiResult.evidence_and_reasoning?.key_supporting_data) {
                analysisText += `<div style="margin-bottom: 1.5rem;">`;
                analysisText += `<h4 style="margin: 0 0 0.75rem 0; color: var(--primary-blue); font-weight: 600;">ğŸ” æ ¸å¿ƒæ”¯æ’‘æ•°æ®</h4>`;
                analysisText += `<ul style="margin-left: 1rem; line-height: 1.6;">`;
                aiResult.evidence_and_reasoning.key_supporting_data.forEach(item => {
                    analysisText += `<li style="margin-bottom: 0.5rem;">${item}</li>`;
                });
                analysisText += `</ul></div>`;
            }

            // 3. åˆ†ææ¨ç†é“¾
            if (aiResult.evidence_and_reasoning?.reasoning_chain) {
                analysisText += `<div style="margin-bottom: 1.5rem;">`;
                analysisText += `<h4 style="margin: 0 0 0.75rem 0; color: var(--primary-blue); font-weight: 600;">ğŸ§  åˆ†ææ¨ç†</h4>`;
                aiResult.evidence_and_reasoning.reasoning_chain.forEach((reason, index) => {
                    analysisText += `<div style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--light-gray); border-radius: 6px; border-left: 3px solid var(--primary-blue);">`;
                    analysisText += `<strong>${index + 1}. </strong>${reason}`;
                    analysisText += `</div>`;
                });
                analysisText += `</div>`;
            }

            // 4. è¯¦ç»†è¯„ä¼°
            if (aiResult.detailed_analysis) {
                const detail = aiResult.detailed_analysis;
                analysisText += `<div style="margin-bottom: 1.5rem;">`;
                analysisText += `<h4 style="margin: 0 0 0.75rem 0; color: var(--primary-blue); font-weight: 600;">ğŸ“Š è¯¦ç»†è¯„ä¼°</h4>`;
                analysisText += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">`;
                
                if (detail.fundamental_strength) {
                    analysisText += `<div style="padding: 0.75rem; background: var(--light-gray); border-radius: 6px; text-align: center;">`;
                    analysisText += `<div style="font-weight: 600; color: var(--text-primary);">åŸºæœ¬é¢å¼ºåº¦</div>`;
                    analysisText += `<div style="font-size: 1.1rem; color: var(--success-green); margin-top: 0.25rem;">${detail.fundamental_strength}</div>`;
                    analysisText += `</div>`;
                }
                
                if (detail.technical_outlook) {
                    analysisText += `<div style="padding: 0.75rem; background: var(--light-gray); border-radius: 6px; text-align: center;">`;
                    analysisText += `<div style="font-weight: 600; color: var(--text-primary);">æŠ€æœ¯é¢å±•æœ›</div>`;
                    analysisText += `<div style="font-size: 1.1rem; color: var(--primary-blue); margin-top: 0.25rem;">${detail.technical_outlook}</div>`;
                    analysisText += `</div>`;
                }
                
                if (detail.valuation_assessment) {
                    analysisText += `<div style="padding: 0.75rem; background: var(--light-gray); border-radius: 6px; text-align: center;">`;
                    analysisText += `<div style="font-weight: 600; color: var(--text-primary);">ä¼°å€¼è¯„ä¼°</div>`;
                    analysisText += `<div style="font-size: 1.1rem; color: var(--warning-orange); margin-top: 0.25rem;">${detail.valuation_assessment}</div>`;
                    analysisText += `</div>`;
                }
                
                analysisText += `</div></div>`;
            }

            // 5. é£é™©å› ç´ 
            if (aiResult.detailed_analysis?.risk_factors) {
                analysisText += `<div style="margin-bottom: 1.5rem;">`;
                analysisText += `<h4 style="margin: 0 0 0.75rem 0; color: var(--danger-red); font-weight: 600;">âš ï¸ é£é™©å› ç´ </h4>`;
                analysisText += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                aiResult.detailed_analysis.risk_factors.forEach(risk => {
                    analysisText += `<span style="background: var(--danger-red); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">${risk}</span>`;
                });
                analysisText += `</div></div>`;
            }

            // 6. å‚¬åŒ–å› ç´ 
            if (aiResult.detailed_analysis?.catalysts) {
                analysisText += `<div style="margin-bottom: 1.5rem;">`;
                analysisText += `<h4 style="margin: 0 0 0.75rem 0; color: var(--success-green); font-weight: 600;">ğŸš€ å‚¬åŒ–å› ç´ </h4>`;
                analysisText += `<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
                aiResult.detailed_analysis.catalysts.forEach(catalyst => {
                    analysisText += `<span style="background: var(--success-green); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">${catalyst}</span>`;
                });
                analysisText += `</div></div>`;
            }

            // 7. è¡Œä¸šå¯¹æ¯”
            if (aiResult.sector_comparison) {
                const sector = aiResult.sector_comparison;
                analysisText += `<div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f0f8ff 0%, #f8f9fa 100%); border-radius: 8px; border-left: 4px solid var(--primary-blue);">`;
                analysisText += `<h4 style="margin: 0 0 0.75rem 0; color: var(--primary-blue); font-weight: 600;">ğŸ­ è¡Œä¸šå¯¹æ¯”</h4>`;
                if (sector.industry_position) {
                    analysisText += `<div><strong>è¡Œä¸šåœ°ä½ï¼š</strong>${sector.industry_position}</div>`;
                }
                if (sector.relative_valuation) {
                    analysisText += `<div><strong>ç›¸å¯¹ä¼°å€¼ï¼š</strong>${sector.relative_valuation}</div>`;
                }
                if (sector.competitive_advantages) {
                    analysisText += `<div style="margin-top: 0.5rem;"><strong>ç«äº‰ä¼˜åŠ¿ï¼š</strong></div>`;
                    analysisText += `<div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem;">`;
                    sector.competitive_advantages.forEach(advantage => {
                        analysisText += `<span style="background: var(--primary-blue); color: white; padding: 0.125rem 0.5rem; border-radius: 8px; font-size: 0.8rem;">${advantage}</span>`;
                    });
                    analysisText += `</div>`;
                }
                analysisText += `</div>`;
            }

            return analysisText || 'åŸºäºå¤šç»´åº¦æ•°æ®åˆ†æï¼Œè¯¥è‚¡ç¥¨åŸºæœ¬é¢è¡¨ç°ç¨³å¥ã€‚å…·ä½“åˆ†ææ­£åœ¨ç”Ÿæˆä¸­...';
        }

        // ä¸»åˆ†æå‡½æ•°
        async function loadComprehensiveAnalysis() {
            const stockCode = document.getElementById('stockInput').value.trim();
            
            if (!stockCode || stockCode.length !== 6) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // ä¿å­˜è‚¡ç¥¨ä»£ç åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('currentStockCode', stockCode);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('roadmapSection').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress(20, 'æ­£åœ¨è·å–è‚¡ç¥¨åŸºç¡€æ•°æ®...');
            
            try {
                // è·å–3003ç«¯å£çš„AIç»¼åˆè¯„ä¼°æ•°æ®
                updateProgress(60, 'æ­£åœ¨è¿›è¡ŒAIæ™ºèƒ½åˆ†æ...');
                const aiAnalysis = await fetch(`http://35.77.54.203:3003/ai/comprehensive-evaluation/${stockCode}`);
                const aiResult = await aiAnalysis.json();
                
                updateProgress(80, 'æ­£åœ¨ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š...');
                
                // è·å–å…¶ä»–æ•°æ®æºï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ä½œä¸ºè¡¥å……ï¼‰
                const [stock, technical, financial, fundFlow] = await Promise.allSettled([
                    fetch(`http://35.77.54.203:3003/stocks/${stockCode}`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/stocks/${stockCode}/analysis/technical`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/stocks/${stockCode}/historical/financial`).then(r => r.json()),
                    fetch(`http://35.77.54.203:3003/api/fund-flow/${stockCode}`).then(r => r.json())
                ]);
                
                updateProgress(100, 'åˆ†æå®Œæˆï¼');
                
                // æ¸²æŸ“å®Œæ•´çš„AIåˆ†æç»“æœ
                renderComprehensiveAnalysis(aiResult, {
                    stock: stock.status === 'fulfilled' ? stock.value : null,
                    technical: technical.status === 'fulfilled' ? technical.value : null,
                    financial: financial.status === 'fulfilled' ? financial.value : null,
                    fundFlow: fundFlow.status === 'fulfilled' ? fundFlow.value : null
                });
                
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('analysisResults').style.display = 'block';
                }, 500);
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                alert('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œè¿æ¥');
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('roadmapSection').style.display = 'block';
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ¸²æŸ“å®Œæ•´çš„AIç»¼åˆåˆ†ææ•°æ®
        function renderComprehensiveAnalysis(aiResult, supplementData) {
            const resultsDiv = document.getElementById('analysisResults');
            
            // å¤„ç†AIåˆ†ææ•°æ®
            const comprehensiveEvaluation = aiResult?.comprehensive_evaluation || {};
            const evidenceAndReasoning = aiResult?.evidence_and_reasoning || {};
            const detailedAnalysis = aiResult?.detailed_analysis || {};
            const sectorComparison = aiResult?.sector_comparison || {};
            const rawDataSources = aiResult?.raw_data_sources || {};
            const fundamentalData = rawDataSources?.fundamental_data || {};
            const basicInfo = fundamentalData?.basic_info || {};
            
            // å¤„ç†è´¢åŠ¡æŒ‡æ ‡æ•°æ®
            const financialIndicators = fundamentalData?.financial_indicators || [];
            const latestMetrics = {};
            
            financialIndicators.forEach(indicator => {
                const quarters = Object.keys(indicator).filter(key => key.startsWith('20') && key.length === 8).sort().reverse();
                if (quarters.length > 0) {
                    latestMetrics[indicator['æŒ‡æ ‡']] = indicator[quarters[0]];
                }
            });
            
            resultsDiv.innerHTML = `
                <!-- å¤´éƒ¨æ€»è§ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="overview-card">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <i class="fas fa-chart-line" style="font-size: 2rem;"></i>
                            <div>
                                <h2 style="margin: 0; font-size: 1.5rem;">${basicInfo['è‚¡ç¥¨ç®€ç§°'] || 'æœªçŸ¥è‚¡ç¥¨'}</h2>
                                <p style="margin: 0; opacity: 0.8; font-size: 0.9rem;">${document.getElementById('stockInput').value} | ${basicInfo['è¡Œä¸š'] || 'æœªçŸ¥è¡Œä¸š'}</p>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: end;">
                            <div>
                                <p style="margin: 0; font-size: 2.5rem; font-weight: 700;">ï¿¥${basicInfo['æœ€æ–°'] || 0}</p>
                                <p style="margin: 0; opacity: 0.8;">å½“å‰è‚¡ä»·</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">
                                    ${comprehensiveEvaluation?.investment_rating || 'HOLD'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-card">
                        <h3 class="card-title">
                            <i class="fas fa-bullseye" style="color: var(--success-green);"></i>
                            æŠ•èµ„ç›®æ ‡
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <p style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.85rem;">ç›®æ ‡ä»·æ ¼</p>
                                <p style="margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--success-green);">ï¿¥${comprehensiveEvaluation?.target_price || '--'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 0.5rem 0; color: var(--text-secondary); font-size: 0.85rem;">ä¸Šæ¶¨æ½œåŠ›</p>
                                <p style="margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--primary-blue);">${comprehensiveEvaluation?.upside_potential || '--'}</p>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem;">æŠ•èµ„æœŸé™: ${comprehensiveEvaluation?.time_horizon || '6-12ä¸ªæœˆ'} | ä¿¡å¿ƒæ°´å¹³: ${comprehensiveEvaluation?.confidence_level || 'ä¸­'}</p>
                        </div>
                    </div>
                    
                    <div class="data-card">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar" style="color: var(--warning-orange);"></i>
                            å…³é”®æŒ‡æ ‡
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                            <div>
                                <p style="margin: 0 0 0.25rem 0; color: var(--text-secondary);">æ€»å¸‚å€¼</p>
                                <p style="margin: 0 0 1rem 0; font-weight: 600;">ï¿¥${formatNumber((basicInfo['æ€»å¸‚å€¼'] || 0) / 100000000)}äº¿</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 0.25rem 0; color: var(--text-secondary);">æµé€šå¸‚å€¼</p>
                                <p style="margin: 0 0 1rem 0; font-weight: 600;">ï¿¥${formatNumber((basicInfo['æµé€šå¸‚å€¼'] || 0) / 100000000)}äº¿</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 0.25rem 0; color: var(--text-secondary);">ROE</p>
                                <p style="margin: 0; font-weight: 600; color: var(--success-green);">${formatPercent(latestMetrics['å‡€èµ„äº§æ”¶ç›Šç‡(ROE)'] || 0)}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 0.25rem 0; color: var(--text-secondary);">æ¯›åˆ©ç‡</p>
                                <p style="margin: 0; font-weight: 600; color: var(--success-green);">${formatPercent(latestMetrics['æ¯›åˆ©ç‡'] || 0)}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AIåˆ†æç»“æœå±•ç¤º -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="data-card">
                        <h3 class="card-title">
                            <i class="fas fa-brain" style="color: var(--primary-blue);"></i>
                            AIç»¼åˆåˆ†ææŠ¥å‘Š
                        </h3>
                        <div style="line-height: 1.8; color: var(--text-primary);">
                            ${generateComprehensiveAnalysisText(aiResult)}
                        </div>
                        
                        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--light-gray); border-radius: 12px;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">ğŸ¯ æŠ•èµ„å»ºè®®</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${(aiResult?.recommendations || ['æŒç»­å…³æ³¨å¸‚åœºåŠ¨æ€', 'æ§åˆ¶æŠ•èµ„ä»“ä½æ¯”ä¾‹', 'è®¾ç½®åˆç†æ­¢ç›ˆæ­¢æŸç‚¹']).map(rec => 
                                    `<span class="tag tag-success">${rec}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="data-card">
                            <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">ğŸ“Š è¯„ä¼°ç»´åº¦</h4>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.85rem; color: var(--text-secondary);">åŸºæœ¬é¢å¼ºåº¦</span>
                                        <span style="font-size: 0.85rem; font-weight: 600;">${detailedAnalysis?.fundamental_strength || 'å¼º'}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="background: var(--success-green); width: 85%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.85rem; color: var(--text-secondary);">æŠ€æœ¯é¢å‰æ™¯</span>
                                        <span style="font-size: 0.85rem; font-weight: 600;">${detailedAnalysis?.technical_outlook || 'åå¼º'}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="background: var(--primary-blue); width: 75%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.85rem; color: var(--text-secondary);">ä¼°å€¼å¸å¼•åŠ›</span>
                                        <span style="font-size: 0.85rem; font-weight: 600;">${detailedAnalysis?.valuation_assessment || 'åˆç†åä½'}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="background: var(--warning-orange); width: 70%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-card">
                            <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">ğŸ­ è¡Œä¸šåœ°ä½</h4>
                            <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-primary);">
                                <strong>${sectorComparison?.industry_position || 'è¡Œä¸šé¢†å…ˆåœ°ä½'}</strong>
                            </p>
                            <p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: var(--text-secondary);">
                                ç›¸å¯¹ä¼°å€¼: ${sectorComparison?.relative_valuation || 'ä½äºè¡Œä¸šå¹³å‡'}
                            </p>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                ${(sectorComparison?.competitive_advantages || ['å“ç‰Œä»·å€¼é¢†å…ˆ', 'æŠ€æœ¯ä¼˜åŠ¿æ˜æ˜¾', 'è´¢åŠ¡çŠ¶å†µç¨³å¥']).map(advantage => 
                                    `<span class="tag tag-info">${advantage}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å…³é”®æ”¯æ’‘æ•°æ®å’Œé£é™©å› ç´  -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="data-card">
                        <h3 class="card-title">
                            <i class="fas fa-check-circle" style="color: var(--success-green);"></i>
                            å…³é”®æ”¯æ’‘æ•°æ®
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${(evidenceAndReasoning?.key_supporting_data || ['æ•°æ®åŠ è½½ä¸­...']).map(data => 
                                `<div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <div style="background: var(--success-green); width: 6px; height: 6px; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: var(--text-primary);">${data}</p>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="data-card">
                        <h3 class="card-title">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning-orange);"></i>
                            é£é™©å› ç´ 
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${(detailedAnalysis?.risk_factors || ['å¸‚åœºæ³¢åŠ¨é£é™©', 'è¡Œä¸šç«äº‰é£é™©', 'å®è§‚ç»æµå½±å“']).map(risk => 
                                `<div style="display: flex; align-items: start; gap: 0.75rem;">
                                    <div style="background: var(--warning-orange); width: 6px; height: 6px; border-radius: 50%; margin-top: 0.5rem; flex-shrink: 0;"></div>
                                    <p style="margin: 0; font-size: 0.9rem; line-height: 1.6; color: var(--text-primary);">${risk}</p>
                                </div>`
                            ).join('')}
                        </div>
                        
                        <div style="margin-top: 2rem; padding: 1rem; background: rgba(243, 156, 18, 0.1); border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--warning-orange); font-size: 0.9rem;">ä¸ç¡®å®šæ€§å› ç´ </h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${(evidenceAndReasoning?.uncertainty_factors || ['å¸‚åœºæ³¢åŠ¨', 'æ”¿ç­–å˜åŒ–']).slice(0, 3).map(factor => 
                                    `<span class="tag tag-warning">${factor}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è´¢åŠ¡æŒ‡æ ‡å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
                <div class="data-card" style="margin-bottom: 2rem;">
                    <h3 class="card-title">
                        <i class="fas fa-chart-area" style="color: var(--primary-blue);"></i>
                        æ ¸å¿ƒè´¢åŠ¡æŒ‡æ ‡è¶‹åŠ¿
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <canvas id="revenueChart" class="chart-container"></canvas>
                        </div>
                        <div>
                            <canvas id="profitChart" class="chart-container"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- è¯¦ç»†è´¢åŠ¡æ•°æ®è¡¨æ ¼ -->
                <div class="data-card">
                    <h3 class="card-title">
                        <i class="fas fa-table" style="color: var(--success-green);"></i>
                        å®Œæ•´è´¢åŠ¡æŒ‡æ ‡ (æœ€æ–°å­£åº¦)
                    </h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æŒ‡æ ‡åç§°</th>
                                    <th style="text-align: right;">æ•°å€¼</th>
                                    <th style="text-align: center;">å•ä½</th>
                                    <th style="text-align: center;">åˆ†ç±»</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(latestMetrics).slice(0, 20).map(([metric, value]) => {
                                    const isPercentage = metric.includes('ç‡') || metric.includes('ROE') || metric.includes('ROA');
                                    const isAmount = metric.includes('æ”¶å…¥') || metric.includes('åˆ©æ¶¦') || metric.includes('èµ„äº§') || metric.includes('ç°é‡‘æµ');
                                    let displayValue = value;
                                    let unit = '';
                                    let category = 'åŸºç¡€æŒ‡æ ‡';
                                    
                                    if (isPercentage) {
                                        displayValue = formatPercent(value);
                                        unit = '%';
                                        category = 'æ¯”ç‡æŒ‡æ ‡';
                                    } else if (isAmount && Math.abs(value) > 100000000) {
                                        displayValue = formatNumber(value / 100000000, 2);
                                        unit = 'äº¿å…ƒ';
                                        category = 'é‡‘é¢æŒ‡æ ‡';
                                    } else if (Math.abs(value) > 10000) {
                                        displayValue = formatNumber(value / 10000, 2);
                                        unit = 'ä¸‡';
                                        category = 'æ•°é‡æŒ‡æ ‡';
                                    } else {
                                        displayValue = formatNumber(value, 2);
                                        unit = 'å•ä½';
                                    }
                                    
                                    return `
                                        <tr>
                                            <td style="font-weight: 500;">${metric}</td>
                                            <td style="text-align: right; font-weight: 600;">${displayValue}</td>
                                            <td style="text-align: center; color: var(--text-secondary);">${unit}</td>
                                            <td style="text-align: center;">
                                                <span class="tag tag-info">${category}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button class="expand-btn" onclick="toggleFullFinancialTable()">
                            æŸ¥çœ‹å…¨éƒ¨${Object.keys(latestMetrics).length}ä¸ªè´¢åŠ¡æŒ‡æ ‡
                        </button>
                    </div>
                    
                    <!-- éšè—çš„å®Œæ•´è¡¨æ ¼ -->
                    <div id="fullFinancialTable" class="full-table-hidden" style="margin-top: 2rem; overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æŒ‡æ ‡åç§°</th>
                                    <th style="text-align: right;">æ•°å€¼</th>
                                    <th style="text-align: center;">å•ä½</th>
                                    <th style="text-align: center;">åˆ†ç±»</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(latestMetrics).map(([metric, value]) => {
                                    const isPercentage = metric.includes('ç‡') || metric.includes('ROE') || metric.includes('ROA');
                                    const isAmount = metric.includes('æ”¶å…¥') || metric.includes('åˆ©æ¶¦') || metric.includes('èµ„äº§') || metric.includes('ç°é‡‘æµ');
                                    let displayValue = value;
                                    let unit = '';
                                    let category = 'åŸºç¡€æŒ‡æ ‡';
                                    
                                    if (isPercentage) {
                                        displayValue = formatPercent(value);
                                        unit = '%';
                                        category = 'æ¯”ç‡æŒ‡æ ‡';
                                    } else if (isAmount && Math.abs(value) > 100000000) {
                                        displayValue = formatNumber(value / 100000000, 2);
                                        unit = 'äº¿å…ƒ';
                                        category = 'é‡‘é¢æŒ‡æ ‡';
                                    } else if (Math.abs(value) > 10000) {
                                        displayValue = formatNumber(value / 10000, 2);
                                        unit = 'ä¸‡';
                                        category = 'æ•°é‡æŒ‡æ ‡';
                                    } else {
                                        displayValue = formatNumber(value, 2);
                                        unit = 'å•ä½';
                                    }
                                    
                                    return `
                                        <tr>
                                            <td style="font-weight: 500;">${metric}</td>
                                            <td style="text-align: right; font-weight: 600;">${displayValue}</td>
                                            <td style="text-align: center; color: var(--text-secondary);">${unit}</td>
                                            <td style="text-align: center;">
                                                <span class="tag tag-info">${category}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // æ¸²æŸ“å›¾è¡¨
            setTimeout(() => {
                renderFinancialCharts(financialIndicators);
            }, 100);
        }

        // æ¸²æŸ“è´¢åŠ¡æŒ‡æ ‡å›¾è¡¨
        function renderFinancialCharts(financialIndicators) {
            if (!financialIndicators || financialIndicators.length === 0) return;
            
            // æ‰¾åˆ°è¥ä¸šæ€»æ”¶å…¥å’Œå‡€åˆ©æ¶¦æ•°æ®
            const revenueData = financialIndicators.find(item => item['æŒ‡æ ‡'] === 'è¥ä¸šæ€»æ”¶å…¥');
            const profitData = financialIndicators.find(item => item['æŒ‡æ ‡'] === 'å½’æ¯å‡€åˆ©æ¶¦');
            
            if (revenueData) {
                renderRevenueChart(revenueData);
            }
            
            if (profitData) {
                renderProfitChart(profitData);
            }
        }

        // æ¸²æŸ“è¥ä¸šæ”¶å…¥å›¾è¡¨
        function renderRevenueChart(revenueData) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            // æå–æœ€è¿‘8ä¸ªå­£åº¦çš„æ•°æ®
            const quarters = Object.keys(revenueData).filter(key => key.startsWith('20') && key.length === 8).sort().slice(-8);
            const values = quarters.map(q => (revenueData[q] || 0) / 100000000); // è½¬æ¢ä¸ºäº¿å…ƒ
            const labels = quarters.map(q => `${q.substring(0,4)}Q${Math.ceil(parseInt(q.substring(4,6))/3)}`);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è¥ä¸šæ€»æ”¶å…¥ (äº¿å…ƒ)',
                        data: values,
                        borderColor: '#4A90E2',
                        backgroundColor: 'rgba(74, 144, 226, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'äº¿å…ƒ'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'è¥ä¸šæ€»æ”¶å…¥è¶‹åŠ¿'
                        }
                    }
                }
            });
        }

        // æ¸²æŸ“å‡€åˆ©æ¶¦å›¾è¡¨
        function renderProfitChart(profitData) {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;
            
            // æå–æœ€è¿‘8ä¸ªå­£åº¦çš„æ•°æ®
            const quarters = Object.keys(profitData).filter(key => key.startsWith('20') && key.length === 8).sort().slice(-8);
            const values = quarters.map(q => (profitData[q] || 0) / 100000000); // è½¬æ¢ä¸ºäº¿å…ƒ
            const labels = quarters.map(q => `${q.substring(0,4)}Q${Math.ceil(parseInt(q.substring(4,6))/3)}`);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å½’æ¯å‡€åˆ©æ¶¦ (äº¿å…ƒ)',
                        data: values,
                        backgroundColor: 'rgba(46, 204, 113, 0.8)',
                        borderColor: '#2ECC71',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'äº¿å…ƒ'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'å½’æ¯å‡€åˆ©æ¶¦è¶‹åŠ¿'
                        }
                    }
                }
            });
        }

        // åˆ‡æ¢å®Œæ•´è´¢åŠ¡è¡¨æ ¼æ˜¾ç¤º
        function toggleFullFinancialTable() {
            const fullTable = document.getElementById('fullFinancialTable');
            const button = event.target;
            
            if (fullTable.classList.contains('full-table-hidden')) {
                fullTable.classList.remove('full-table-hidden');
                fullTable.style.display = 'block';
                button.textContent = 'æ”¶èµ·å®Œæ•´è¡¨æ ¼';
            } else {
                fullTable.classList.add('full-table-hidden');
                fullTable.style.display = 'none';
                button.textContent = `æŸ¥çœ‹å…¨éƒ¨è´¢åŠ¡æŒ‡æ ‡`;
            }
        }

        // å¯¼å‡ºåˆ†ææ•°æ®
        function exportAnalysisData() {
            alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }

        // åˆ†äº«åˆ†æ
        function shareAnalysis() {
            const stockCode = document.getElementById('stockInput').value;
            if (stockCode) {
                const url = `${window.location.origin}/analysis?stock=${stockCode}`;
                navigator.clipboard.writeText(url).then(() => {
                    alert('åˆ†æé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            }
        }

        // å…¨å±€è‚¡ç¥¨ä»£ç å…±äº«åŠŸèƒ½
        function loadGlobalStockCode() {
            const savedStockCode = localStorage.getItem('currentStockCode');
            if (savedStockCode) {
                document.getElementById('stockInput').value = savedStockCode;
            }
        }

        // ç›‘å¬å…¶ä»–é¡µé¢çš„è‚¡ç¥¨ä»£ç å˜åŒ–
        window.addEventListener('storage', function(e) {
            if (e.key === 'currentStockCode' && e.newValue) {
                document.getElementById('stockInput').value = e.newValue;
            }
        });

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å›è½¦é”®è§¦å‘åˆ†æ
            document.getElementById('stockInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadComprehensiveAnalysis();
                }
            });
            
            // åŠ è½½å…¨å±€è‚¡ç¥¨ä»£ç 
            loadGlobalStockCode();
            
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const stockParam = urlParams.get('stock');
            if (stockParam) {
                document.getElementById('stockInput').value = stockParam;
                loadComprehensiveAnalysis();
            }
        });
    </script>
</body>
</html>